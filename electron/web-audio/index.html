HELLO!!

<html>
    <script src="../node_modules/webix/webix.js"></script>

    <link rel="stylesheet" href="../node_modules/webix/webix.css">
    <link rel="stylesheet" href="../node_modules/webix/skins/terrace.css">
    <link rel="stylesheet" href="../node_modules/webix/skins/contrast.css">
    <link rel="stylesheet" href="../pydjay_ui/pymusic_style.css">
        
    <!-- <div id="waveform"></div>

    <div id="waveform-preview"></div> -->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/2.0.6/wavesurfer.min.js"></script>
    <script src="decoder.js"></script>
    <script type="text/javascript">

        class PydjayAudioContext {
            /*

            */

            constructor() {
                this.audio_ctx =  new AudioContext()
                this.audio_ctx.destination.channelCount = this.audio_ctx.destination.maxChannelCount
                this.audio_ctx.destination.channelInterpretation = "discrete"
                this.splitter =  this.audio_ctx.createChannelSplitter(this.audio_ctx.destination.maxChannelCount)
                this.splitter.channelInterpretation = "discrete"
                this.splitter.channelCount = this.audio_ctx.destination.maxChannelCount
                this.merger = this.audio_ctx.createChannelMerger(this.audio_ctx.destination.maxChannelCount)
                this.merger.channelInterpretation = "discrete"
                this.merger.channelCount = this.audio_ctx.destination.maxChannelCount
                this.splitter.connect(this.merger, 0, 0)
                this.splitter.connect(this.merger, 1, 1)
                this.duck_under_1 = this.audio_ctx.createGain()
                this.duck_under_2 = this.audio_ctx.createGain()
                this.splitter.connect(this.duck_under_1, 0, 0).connect(this.merger, 0, 4)
                this.splitter.connect(this.duck_under_2, 1, 0).connect(this.merger, 0, 5)
                this.merger.connect(this.audio_ctx.destination)
                this.source = null;
            }
        }

        function MainDeckAudioContext() {
            var self = this;
            this.audio_ctx =  new AudioContext()
            this.audio_ctx.destination.channelCount = this.audio_ctx.destination.maxChannelCount
            this.audio_ctx.destination.channelInterpretation = "discrete"
            this.splitter =  this.audio_ctx.createChannelSplitter(this.audio_ctx.destination.maxChannelCount)
            this.splitter.channelInterpretation = "discrete"
            this.splitter.channelCount = this.audio_ctx.destination.maxChannelCount
            this.merger = this.audio_ctx.createChannelMerger(this.audio_ctx.destination.maxChannelCount)
            this.merger.channelInterpretation = "discrete"
            this.merger.channelCount = this.audio_ctx.destination.maxChannelCount
            this.splitter.connect(this.merger, 0, 0)
            this.splitter.connect(this.merger, 1, 1)

            this.duck_under_1 = this.audio_ctx.createGain()
            this.duck_under_2 = this.audio_ctx.createGain()

            //this.splitter.connect(this.duck_under_1, 0, 0).connect(this.merger, 0, 4)
            //this.splitter.connect(this.duck_under_2, 1, 0).connect(this.merger, 0, 5)
            this.merger.connect(this.audio_ctx.destination)

            this.source = null;

            this.play = function (buffer, start, end) {
                self.stop()
                self.source = self.audio_ctx.createBufferSource()
                self.source.buffer = buffer //(wavesurfer.backend.buffer)
                self.source.channelInterpretation = "discrete"
                self.source.connect(self.splitter)
                if ((start != undefined) && (end != undefined)) {
                    self.source.start(0, start, end - start)
                } else if (start != undefined) {
                    self.source.start(0, start)
                } else {
                    self.source.start(0, start)
                }
            }

            this.stop = function () {
                (self.source != null) && self.source.stop()
                self.source = null
            }

            this.set_monitor_volume = function (volume) {
                self.duck_under_1.gain.linearRampToValueAtTime(volume, self.audio_ctx.currentTime + 0.75)
                self.duck_under_2.gain.linearRampToValueAtTime(volume, self.audio_ctx.currentTime + 0.75)
            }

            this.duck_monitor = function () {
                self.set_monitor_volume(0.001)
            }

            this.restore_monitor = function () {
                self.set_monitor_volume(1)
            }

        }

        function PreviewDeckAudioContext() {
            var self = this;
            this.audio_ctx =  new AudioContext()
            this.audio_ctx.destination.channelCount = this.audio_ctx.destination.maxChannelCount
            this.audio_ctx.destination.channelInterpretation = "discrete"
            this.splitter =  this.audio_ctx.createChannelSplitter(this.audio_ctx.destination.maxChannelCount)
            this.splitter.channelInterpretation = "discrete"
            this.splitter.channelCount = this.audio_ctx.destination.maxChannelCount
            this.merger = this.audio_ctx.createChannelMerger(this.audio_ctx.destination.maxChannelCount)
            this.merger.channelCount = this.audio_ctx.destination.maxChannelCount
            this.merger.channelInterpretation = "discrete"
            //this.splitter.connect(this.merger, 0, 4)
            //this.splitter.connect(this.merger, 1, 5)
            this.merger.connect(this.audio_ctx.destination)

            this.play = function (buffer, start, end) {
                self.stop()
                self.source = self.audio_ctx.createBufferSource()
                self.source.buffer = buffer //(wavesurfer.backend.buffer)
                self.source.channelInterpretation = "discrete"
                self.source.connect(self.splitter)
                if ((start != undefined) && (end != undefined)) {
                    self.source.start(0, start, end - start)
                } else if (start != undefined) {
                    self.source.start(0, start)
                } else {
                    self.source.start(0, start)
                }
            }

            this.pause = function () {

            }

            this.stop = function () {
                (self.source != null) && self.source.stop()
                self.source = null
            }
        }

        foo = webix.ui({
            rows: [
                {
                    height:100,
                    view:"template",
                    template:'<div id="waveform"></div>'
                },
                {
                    cols: [
                        {},
                        {
                            view: "button",
                            label: "PLAY", 
                            click: function () {
                                console.log(main_context)
                                main_context.play(wavesurfer.backend.buffer)
                            }
                        },
                        {}
                    ]
                },
                {
                    height:100,
                    view:"template",
                    template:'<div id="waveform-preview"></div>'
                },
                {
                    cols: [
                        {},
                        {
                            view: "button",
                            label: "PLAY", 
                            click: function () {
                                pre_context.play(wavesurfer2.backend.buffer)
                            }
                        },
                        {}
                    ]
                },

            ]
        })



        var main_context = new MainDeckAudioContext()
        var pre_context = new PreviewDeckAudioContext()
        var wavesurfer = WaveSurfer.create({
            container: '#waveform',
            pixelRatio: 1,
            scrollParent: true,
            hideScrollbar: true,
            //audioContext:main_context
        });
        var wavesurfer2 = WaveSurfer.create({
            container: '#waveform-preview',
            scrollParent: true,
            hideScrollbar: true,
            // waveColor: "purple",
            // progressColor: "blue",
            //audioContext:preview_context
        });
        wavesurfer.on("ready", function () {
            console.log("ready")
        })
        //wavesurfer.load('track_1.mp3');

        wavesurfer2.on("ready", function () {
            console.log("ready")
        })

        //wavesurfer2.load('track_2.mp3');
        //main_context.source.start()
        //wavesurfer.backend.ac.destination.addEventListener("audioprocess", () => {console.log("x")})
    </script>
</html>
