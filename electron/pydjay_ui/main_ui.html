<!DOCTYPE html>
<title>PYMUSIC DJ App</title>
<script src="../node_modules/webix/webix.js"></script>
<script src="../lib/progressbar.js"></script>

<script src="../web-audio/event_dispatcher.js"></script>
<script src="../web-audio/audio_context.js"></script>
<script src="../web-audio/audio_player.js"></script>
<script src="../web-audio/audio_player_base.js"></script>
<script src="../web-audio/audio_player_buffer.js"></script>
<script src="../web-audio/audio_player_file.js"></script>


<script src="./utils.js"></script>
<script src="./sql.js"></script>
<script src="./data.js"></script>
<script src="./main_list_display.js"></script>
<script src="./queue_display.js"></script>
<script src="./playlist_edit.js"></script>
<script src="./sidebar.js"></script>
<script src="./playback.js"></script>
<!-- <script src="./track_edit.js"></script> -->
<script src="./track_edit_class.js"></script>
<script src="./track_add.js"></script>
<script src="./queue.js"></script>
<script src="./actions.js"></script>
<link rel="stylesheet" href="../node_modules/webix/webix.css">
<link rel="stylesheet" href="../node_modules/webix/skins/terrace.css">
<link rel="stylesheet" href="../node_modules/webix/skins/contrast.css">
<link rel="stylesheet" href="./pymusic_style.css">


<body>
  <article id="mainArticle">
  </article>
</body>
<script type="text/javascript">
$ = require('jquery')
// Highcharts = require('highcharts')
WaveSurfer = require("wavesurfer.js")
var WaveSurferRegions = require('wavesurfer.js/dist/plugin/wavesurfer.regions.min.js');
var path = require('path');
var dialog = require('electron').remote.dialog;

var player_window = {
    height:58,
    gravity:1,
    css:{
        'background-color':'#3c3c3c',
        'padding':'0px',
        border: '1px solid #5c5c5c',
     },
    cols:[
        {
            id:'main-cover-image',
            view: 'template',
            width:58,
            height:58,
            template: ""
        },
        {width:5},
        {
            rows:[
                {height:7},
                {
                    cols: [
                        {
                            rows: [
                                {
                                    id:'main-title',
                                    view: 'label',
                                    css: {
                                        'text-align':'left',
                                        'text-transform':'uppercase',
                                        'font-weight':'bold'
                                    },
                                    label: 'Title Of Song',
                                    height:20
                                },
                                {
                                    id:'main-artist',
                                    view: 'label',
                                    css: {
                                        'text-align':'left',
                                        'white-space':'nowrap',
                                        'overflow': 'hidden',
                                        'text-overflow': 'ellipsis'
                                    },
                                    label: 'Artist - Album',
                                    height:20
                                }
                            ]
                        },
                        {
                            id:'main_track_time',
                            view: 'label',
                            css: {
                                'text-align':'right',
                                'font-size':'20px',
                                'font-weight':800
                            },
                            label: '-00:00',
                            height:15,
                            width:75
                        },
                        {width:5}
                    ]
                },
                {height:2},
                {cols:[
                    {width:2},
                    {
                        height:5,
                        css:{margin:0, padding:0, border: '0px solid #3c3c3c'},
                        template:'<div id="main-player-progress" style="border: \'0px solid black\'; width:100%; height:100%; position:relative; top:0%; transform: translateY(-150%)"></div>'
                    },
                    {width:7}
                ]}
            ]
        }
    ]
}

var main_player_progress =undefined;
$(document).ready( () => {
    main_player_progress = new ProgressBar.Line('#main-player-progress',
    {
     strokeWidth: 1,
     easing: 'easeInOut',
     duration: 5,
     color: '#5a5a5a',
     trailColor: '#eee',
     trailWidth: 1,
     svgStyle: {width: '100%', height: '100%'}});
    main_player_progress.animate(0);
    //$$("preview-play-context-menu").attachTo($$('preview_test_play_button'))
});


var preview_seek = undefined;
webix.ready( () => {
    preview_seek = new ProgressBar.Line('#preview-progress',
    {
        strokeWidth: 1,
        duration: 5,
        color: '#5a5a5a',
        trailColor: '#eee',
        trailWidth: 1,
        svgStyle: {width: '100%', height: '100%'}
    }
 );
    preview_seek.animate(0);
    //$$("preview-play-context-menu").attachTo($$("preview_test_play_button"));
});

//var preview_context_menu = webix.ui({
//        id: "preview-play-context-menu",
//        view:"contextmenu",
//        data:["Add","Rename","Delete",{ $template:"Separator" },"Info"],
//        on:{
//            onItemClick:function(id){
//                var context = this.getContext();
//                var list = context.obj; //list item object
//                var listId = context.id; //id of the clicked list item
//                webix.message("List item: <i>"+list.getItem(listId).title+"</i> <br/> Context menu item: <i>"+this.getItem(id).value+"</i>");
//            }
//        }
//    }//
//)

var track_add_progress_dialog =  webix.ui({
    view:"window",
    modal:true,
    position:"center",
    width:600,
    height:400,
    head: false,
    body:{
        rows:[
            {height:10},
            {
                id:'track_add_progress',
                view: "label",
                label:"Processing track ### of ###",
                css: {
                    'text-align': 'center',
                    'font-size':  '20px',
                }
            },
            {height:10},
            {
                id:'track_add_title',
                view: "label",
                label:"Title Of Song",
                css: {
                    'text-align': 'center',
                    'font-size': '20px',
                }

            },
            {
                id:'track_add_artist',
                view: "label",
                label:"Artist - Album",
                css: {
                    'text-align': 'center',
                    'font-size':  '15px',
                }

            }
        ]
    }
})
track_add_progress_dialog.hide();

// var track_data_edit_window = webix.ui({
//     id: "track_edit_window",
//     view: "window",
//     modal: true,
//     position: "center",
//     width: 1275,
//     height: 700,
//     head: "EDIT TRACK DATA",
//     body:{
//         rows:[
//             {height:30},
//             {
//                 cols:[
//                     {width:20},
//                     {
//                         id:'main-cover-image-edit',
//                         view: 'template',
//                         width:128,
//                         height:128,
//                         template: ""
//                     },
//                     {width:20},
//                     {
//                         rows:[
//                             {height:7},
//                             {
//                                 cols: [
//                                     {
//                                         rows: [
//                                             {
//                                                 id:'main-title-edit',
//                                                 view: 'label',
//                                                 css: {
//                                                     'text-align': 'left',
//                                                     'text-transform': 'uppercase',
//                                                     'font-weight': 'bold',
//                                                     'font-size': '20px'
//                                                 },
//                                                 label: 'Title Of Song',
//                                                 height:30
//                                             },
//                                             {height:5},
//                                             {
//                                                 id:'main-artist-edit',
//                                                 view: 'label',
//                                                 css: {
//                                                     'text-align':'left',
//                                                     'font-size': '20px',
//                                                     'color': '#bfbfbf'
//                                                 },
//                                                 label: 'Artist',
//                                                 height:30
//                                             },
//                                             {},
//                                             {
//                                                 id:'track-data',
//                                                 view: 'label',
//                                                 css: {
//                                                     'text-align':'left',
//                                                     'font-size':'20px'
//                                                 },
//                                                 label: 'length - BPM',
//                                                 height:30
//                                             }//,
//                                             // {
//                                             //     id:'track-data-bpm',
//                                             //     view: 'label',
//                                             //     css: {
//                                             //         'text-align':'left',
//                                             //         'font-size':'20px'
//                                             //     },
//                                             //     label: ' - BPM',
//                                             //     height:30
//                                             // }
//                                         ]
//                                     }
//                                 ]
//                             }
//                         ]
//                     },
//                     {width:20}
//                 ]
//             },
//             {height:50},
//             {
//                 cols: [
//                     {
//                         id:'edit_zoom_first_10_seconds_button',
//                         view:'button',
//                         type:'icon',
//                         label: 'FIRST 10 SECONDS',
//                         click : function () {
//                             track_edit_waveform.xAxis[0].setExtremes(0, 10000000000, true, false);
//                             webix.UIManager.setFocus($$('track_edit_window'));
//                         }
//                     },
//                     {
//                         id:'edit_zoom_first_30_seconds_button',
//                         view:'button',
//                         type:'icon',
//                         label: 'FIRST 30 SECONDS',
//                         click : function () {
//                             track_edit_waveform.xAxis[0].setExtremes(0, 30000000000, true, false);
//                             webix.UIManager.setFocus($$('track_edit_window'));
//                         }
//                     },
//                     {},
//                     {
//                         id:'edit_reset_zoom_button',
//                         view:'button',
//                         type:'icon',
//                         label: 'RESET',
//                         click : function () {
//                             track_edit_waveform.xAxis[0].setExtremes(0, track_length_edit, true, false);
//                             webix.UIManager.setFocus($$('track_edit_window'));
//                         }
//                     },
//                     {},
//                     {
//                         id:'edit_zoom_last_30_seconds_button',
//                         view:'button',
//                         type:'icon',
//                         label: 'LAST 30 SECONDS',
//                         click : function () {
//                             track_edit_waveform.xAxis[0].setExtremes(track_length_edit - 30000000000, track_length_edit, true, false);
//                             webix.UIManager.setFocus($$('track_edit_window'));
//                         }
//                     },
//                     {
//                         id:'edit_zoom_last_10_seconds_button',
//                         view:'button',
//                         type:'icon',
//                         label: 'LAST 10 SECONDS',
//                         click : function () {
//                             track_edit_waveform.xAxis[0].setExtremes(track_length_edit - 10000000000, track_length_edit, true, false);
//                             webix.UIManager.setFocus($$('track_edit_window'));
//                         }
//                     }
//                 ]
//             },
//             {
//                 cols:[
//                     {width:20},
//                     {
//                         height:175,
//                         css:{
//                             margin:0,
//                             padding:0,
//                             border: '0px solid #3c3c3c'
//                         },
//                         template:'<div id="track-waveform" style="border: \'1px solid black\'; width:100%; height:100%; position:relative; top:0%;"></div>'
//                     },
//                     {width:20}
//                 ]
//             },
//             {height:30},
//             {
//                 cols: [
//                     {width:30},
//                     {
//                         id:'edit_play_button',
//                         view:'button',
//                         label: 'PLAY FULL TRACK',
//                         click : function () {
//                             preview_play_track_id(track_edited.id, stream_start_edit, stream_end_edit);
//                             webix.UIManager.setFocus($$('track_edit_window'));
//                         }
//                     },
//                     {
//                         id:'edit_play_last_30_seconds_button',
//                         view:'button',
//                         label: 'LAST 30 SECONDS',
//                         click : function () {
//                             preview_play_track_id(track_edited.id, -30000000000, stream_end_edit);
//                             webix.UIManager.setFocus($$('track_edit_window'));
//                         }
//                     },
//                     {
//                         id:'edit_play_last_10_seconds_button',
//                         view:'button',
//                         label: 'LAST 10 SECONDS',
//                         click : function () {
//                             preview_play_track_id(track_edited.id, -10000000000, stream_end_edit);
//                             webix.UIManager.setFocus($$('track_edit_window'));
//                         }
//                     },
//                     {},
//                     {
//                         id:'edit_stop_button',
//                         view:'button',
//                         label: 'STOP',
//                         click : function () {
//                             preview_stop();
//                             webix.UIManager.setFocus($$('track_edit_window'));
//                         }
//                     },
//                     {width:30}
//                 ]
//             },
//             {height:60},
//             {
//                 cols:[
//                     {width:30},
//                     {
//                         view: 'button',
//                         label: 'APPLY',
//                         click: function () {
//                             save_new_track_info();
//                             preview_stop();
//                             track_data_edit_window.hide()
//                         }
//                     },
//                     {},
//                     {
//                         view: 'button',
//                         label: 'CANCEL',
//                         click: () => {
//                             preview_stop();
//                             track_data_edit_window.hide()
//                         }
//                     },
//                     {width:30}
//                 ]
//             },
//             {height:10}
//         ]
//     }
// })
// track_data_edit_window.hide();
// var track_edit_waveform = undefined
// track_data_edit_window.attachEvent(
//     'onShow',
//     function () {
//         if (track_edit_waveform == undefined) {
//             create_waveform_visualizer();
//         }
//         track_edit_waveform.xAxis[0].removePlotLine('position-marker');
//         track_edit_waveform.xAxis[0].addPlotLine({
//             color:'#FF0000',
//             width: 2,
//             zIndex: 10,
//             value: 0,
//             id: 'position-marker'});
//         preview_stop()
//     }
// )


// function create_waveform_visualizer () {
//     // track_edit_waveform = WaveSurfer.create({
//     //         container: '#track-waveform',
//     //         pixelRatio: 1,
//     //         scrollParent: false,
//     //         hideScrollbar: true,
//     //         waveColor: 'violet'
//     //         //audioContext:main_context
//     //     });
//     track_edit_waveform = new Highcharts.chart({

//         chart: {
//             renderTo: 'track-waveform',
//             type: 'spline',
//             zoomType:'x',
//             spacingLeft:0,
//             spacingBottom:0,
//             backgroundColor: '#3c3c3c',
//             plotBackgroundColor: '#3c3c3c',
//             plotBorderWidth: 0,
//             events: {
//                 redraw: function() {
//                     webix.UIManager.setFocus($$('track_edit_window'));
//                 }
//             },
//             resetZoomButton: {
//                 theme: {
//                     display: 'none'
//                 }
//             }
//         },
//         tooltip: { enabled: false },
//         yAxis: {title: {text: ''},
//         labels: {enabled: false},
//         tickPositioner: function () {
//                     var maxDeviation = Math.max(Math.abs(this.dataMax), Math.abs(this.dataMin));
//                     var halfMaxDeviation = Math.ceil(maxDeviation / 2);
//                     return [-maxDeviation, -halfMaxDeviation, 0, halfMaxDeviation, maxDeviation];
//                     }},
//         xAxis: {title: {text: ''}, labels: {enabled: true}},
//         legend: {enabled: false},
//         title: {text: ''},
//         plotOptions: {
//             spline: {
//                 marker: {
//                     enabled: false
//                 }
//             }
//         },

//         series: [{
//             name: '',
//             states: {hover: {enabled: false}},
//             data: []
//         }]
//     });
// }

function save_current_session() {
    x = webix.ui({
        view:"window",
        modal:true,
        position:"center",
        width:600,
        height:400,
        head: "SAVE CURRENT SESSION",
        body:{
            rows:[
                {height:10},
                {
                    id:'session_name',
                    view: "text",
                    value:'',
                    label:"Name:"
                },
                {
                    id:'session_location',
                    view:"text",
                    value:'',
                    label:"Location:"
                },
                {
                    id:'session_address',
                    view:"text",
                    value:'',
                    label:"Address:"
                },
                {height:30},
                {
                    cols:[
                        {},
                        {
                            view: 'button',
                            label: 'SAVE',
                            click: function () {
                                save_session($$('session_name').getValue(),
                                             $$('session_location').getValue(),
                                             $$('session_address').getValue());
                                x.hide();
                            }
                        },
                        {},
                        {
                            view: 'button',
                            label: 'CANCEL',
                            click: () => {x.hide()}
                        },
                        {}
                    ]
                },
                {height:10}
            ]
        }
    })
    session_popup.hide()
    x.show();
}

function playback_settings() {
    db_connection.query(
        'SELECT wait_time FROM settings',
        function (e, r) {
            if (e) throw e;
            wait_time = r[0].wait_time;
            x = webix.ui({
                view:"window",
                modal:true,
                position:"center",
                width:600,
                height:400,
                head: "PLAYBACK SETTINGS",
                body:{
                    rows:[
                        {height:10},
                        {
                            id:'wait_time',
                            view: "text",
                            value: `${wait_time}`,
                            labelWidth:225,
                            label:"Delay between tracks (seconds):"
                        },
                        {height:30},
                        {
                            view: "button",
                            type: 'icon',
                            icon: "headphones",
                            label: "Reset audio system",
                            click: reset_audio

                        },
                        {height:30},
                        {
                            cols:[
                                {},
                                {
                                    view: 'button',
                                    label: 'APPLY',
                                    click: function () {
                                        db_connection.query(
                                            `UPDATE settings SET wait_time=${parseInt($$('wait_time').getValue())}`,
                                            function (error, x) {
                                                if (error) throw error;
                                                x.hide();
                                            }
                                        )
                                        x.hide();
                                    }
                                },
                                {},
                                {
                                    view: 'button',
                                    label: 'CANCEL',
                                    click: () => {x.hide()}
                                },
                                {}
                            ]
                        },
                        {height:10}
                    ]
                }
            })
            x.show();
        }
    )
}

main_list_display_template.gravity = 2.25;
var session_popup = webix.ui(
    {
        view:"popup",
        id:"session_popup",
        height:700,
        width:500,
        body:{
            rows:[
                {
                    cols: [
                        {
                            view:'label',
                            label:"<b>PLAYED SONGS</b>",
                            height:30
                        },
                        {
                            gravity:.5,
                            id: 'session_save_button',
                            view:'button',
                            label:"SAVE",
                            height:30,
                            click: save_current_session,
                        }
                    ]
                },
                {height:10},
                {
                    view:'list',
                    id:'session_list_view',
                    template: queue_element_template,
                    type: { height: cover_size  }
                }
            ]
        }
})
session_popup.hide();
$$('session_save_button').hide();
session_popup.attachEvent('onShow', function () {
    var sql = `SELECT tracks.id as track_id, session_queue.id as id, session_queue.position, tracks.title, tracks.artist,
                    tracks.album, tracks.bpm, tracks.stream_length,
                    settings.db_image_cache as image_root, tracks.cover_small as cover,
                    session_queue.position as position
             FROM
                 (tracks LEFT JOIN settings ON 1) LEFT JOIN session_queue
             ON
                 tracks.id=session_queue.track_id WHERE session_queue.status='played'
             ORDER BY session_queue.position`

    db_connection.query(sql, function (err, result) {
      if (err) throw err;
      $$('session_list_view').clearAll();
      if (result.length == 0) {
          $$('session_save_button').hide();
      } else {
          if (!queue_playing) {
              $$('session_save_button').show();
          } else {
              $$('session_save_button').hide();
          }
      }
      for(var i=0; i < result.length; i++){
          $$('session_list_view').add(result[i])
      }
    });
})



var popup = webix.ui({
    view:"popup",
    id:"skip_stop_dialog",
    height:650,
    width:400,
    body:{
        rows: [
            {
                view: 'label',
                label: '<b>SKIP SONG/STOP QUEUE</b>'
            },
            {
                cols: [
                    {
                        view:'button',
                        type:'icon',
                        icon:'stop',
                        label:'STOP QUEUE',
                        maxHeight:35,
                        click: stop_queue_now
                    },
                    {
                        view:'button',
                        type:'icon',
                        icon:'step-forward',
                        label:'SKIP SONG',
                        maxHeight:35,
                        click: skip_to_next_track
                    }
                ]
            }
        ]
    }
})
popup.hide();


var preview_popup = webix.ui({
    view:"popup",
    id:"preview_popup_menu",
    height:650,
    width:200,
    body:{
        rows: [
            {
                view:'button',
                type:'icon',
                // icon:'stop',
                label:'Play full track',
                maxHeight:35,
                click: () => {
                    url = pl.url
                    pl.play(url)
                    $$("preview_popup_menu").hide()
                }
            },
            {
                view:'button',
                type:'icon',
                label:'Play last 30 seconds',
                maxHeight:35,
                click: () => {
                    $$("preview_popup_menu").hide()
                }
            },
            {
                view:'button',
                type:'icon',
                // icon:'stop',
                label:'Play last 10 seconds',
                maxHeight:35,
                click: () => {
                    $$("preview_popup_menu").hide()
                }
                //click: stop_queue_now
            }
        ]
    }
})
popup.hide();



main_menu_popup  = webix.ui({
    view: 'popup',
    id: "main_menu_popup",
    width: 400,
    autoheight: true,
    relative: 'bottom',
    body: sidebar_template
})
main_menu_popup.hide()

var datatable = webix.ui({
    css:{
                'background-color':'#515151',
                'padding':'0px',
                'border-bottom': "1px solid #CCCCCC",
            },
    rows:[
        {
            css:{
                'background-color':'#515151',
                'padding':'0px',
                'border-bottom': "1px solid #CCCCCC",
            },
            cols:[
                {
                    cols:[
                        {},
                        {
                            view:'button',
                            type:'icon',
                            icon:'list',
                            label:'SESSION',
                            height:25,
                            width:100,
                            popup:'session_popup'
                        }
                    ]
                },
                player_window,
                {
                    cols:[
                        // {
                        //     css: {
                        //         //'background-color':'#515151',
                        //         //'padding':'0px',
                        //         //'border-bottom': "1px solid #CCCCCC",
                        //         //'height': "100% !important"
                        //     },
                        //     width:1
                        // },
                        {
                            width:250,
                            cols:[
                                {width:7},
                                {
                                    gravity:.5,
                                    view:'template',
                                    id: 'queue_stop_message',
                                    css: {
                                        'text-align':'center',
                                        'vertical-align': 'middle',
                                        color: '#fbbbbbb',
                                        'background-color': '#870053'
                                    },
                                    template:'<span style="vertical-align:bottom"><b>Queue will stop after this song</b></span>',
                                    maxHeight:35
                                },
                                {width:15}
                            ]
                        },
                        {
                            gravity:.5,
                            id:'start-stop-button',
                            view:'button',
                            type:'icon',
                            icon:'play',
                            label:'START',
                            click: start_queue,
                            maxHeight:35
                        },
                        {
                            gravity:.5,
                            view:'button',
                            type:'icon',
                            icon:'step-forward',
                            label:'SKIP/STOP',
                            popup: "skip_stop_dialog",
                            maxHeight:35
                        },
                        {
                            gravity:.5,
                            view:'button',
                            type:'icon',
                            icon:'cog',
                            label:'SETTINGS',
                            click: playback_settings,
                            maxHeight:35
                        },
                        // {
                        //     gravity:.5,
                        //     view:'button',
                        //     type:'icon',
                        //     icon:'plus',
                        //     label:'ADD',
                        //     autowidth:true,
                        //     click: add_track,
                        //     maxHeight:35
                        // }
                    ]
                }
            ]
        },
        {
            cols:[
                sidebar_template,
                main_list_display_template,
                {
                    width:494,
                    rows: [
                        queue_display_template,
                        // {
                        //     height:5,
                        //     css: {
                        //         'background-color': '#3c3c3c',
                        //         'border-color':"0px solid #3c3c3c"
                        //     }
                        // },
                        { view:"property", id:"metadata", width:100,disable:true,height:285, labelWidth:100,
                            elements:[
                            { label:"Metadata", type:"label"},
                            { label:"<b>Title:</b>", type:"text", id:"title"},
                            { label:"<b>Artist:</b>", type:"text", id:"artist"},
                            { label:"<b>Album:</b>", type:"text", id:"album"},
                            { label:"<b>Year:</b>", type:"text", id:"year"},
                            { label:"<b>Genre:</b>", type:"text", id:"genre"},
                            { label:"<b>Color:</b>", type:"color", id:"color"},
                            { label:"Info", type:"label"},
                            { label:"<b>BPM:</b>", type:"text", id:"bpm"},
                            { label:"<b>Duration:</b>", type:"text", id:"track_length"},
                            // { label:"<b>Bitrate:</b>", type:"text", id:"track_start"},
                            // { label:"<b>Samplerate:</b>", type:"text", id:"track_end"},
                            // { label:"<b>Samplerate:</b>", type:"text", id:"track_end"},
                            // { label:"<b>Samplerate:</b>", type:"text", id:"track_end"},
                            // { label:"<b>Samplerate:</b>", type:"text", id:"track_end"},
                            ]
                        },
                        preview_player_window,
                        //suggestions_display_template
                    ]
                }
            ]
        },
        {
            height:40,
            css: {
                'background-color': '#202020',
                'border-top':"1px solid #3f3f3f",
            },
            cols:[
                {
                    width:15
                },
                {
                    view: 'label',
                    id: 'calendar',
                    label: '<span style="color:rgb(200,200,200)">2018-01-09</span> | 0:45',
                    height: 20
                },
                {
                    view: 'label',
                    id: 'queue_duration',
                    label: '<b>QUEUE DURATION:</b> 0:00',
                    height: 20
                },
                {
                    view: 'label',
                    id:'queue_ends_at',
                    label: '<b>ENDS:</b> 0:00',
                    height: 20
                },
                {
                    id:'main-player-volume',
                    view:'button',
                    type:'icon',
                    icon:'volume-up',
                    label:'100%',
                    width:75
                },
                {
                    id:'monitor-volume',
                    view:'button',
                    type:'icon',
                    icon:'volume-control-phone',
                    label:'100%',
                    width:75
                },
                {
                    id:'precue-player-volume',
                    view:'button',
                    type:'icon',
                    icon:'headphones',
                    label:'100%',
                    width:75
                },
                {
                    width:15
                }
            ]
        }
    ]
});
$$('queue_stop_message').hide();

$$("display_list").filterByAll = function () {
    var text = $$('track_filter').getValue()
    var i=0;
    search_tokens = text.split(' ')
    search_f = [];
    for (var i=0; i<search_tokens.length; i++) {
        let token = search_tokens[i];
        if (token.length > 0) {
            if (search_tokens[i].startsWith('@bpm<')) {
                let x = parseInt(search_tokens[i].split('<')[1]);
                if (!isNaN(x)) {
                    search_f.push(
                        function (obj) {
                            return obj.bpm <= x;
                        }
                    )
                } else {
                    search_f.push( (x) => {return true} )
                }
            } else if (search_tokens[i].startsWith('@bpm>')) {
                let x = parseInt(search_tokens[i].split('>')[1]);
                if (!isNaN(x)) {
                    search_f.push(
                        function (obj) {
                            return (obj.bpm >= x);
                        }
                    )
                } else {
                    search_f.push( (x) => {return true} )
                }
            } else if (search_tokens[i].startsWith('@bpm~')) {
                let x = parseInt(search_tokens[i].split('~')[1]);
                if (!isNaN(x)) {
                    search_f.push(
                        function (obj) {
                            return (obj.bpm < x*1.2) && (obj.bpm > x*0.9) ;
                        }
                    )
                } else {
                    search_f.push( (x) => {return true} )
                }
            } else {
                search_f.push(
                    function (x) {
                        fields = [x.title, x.artist, x.genre, `@rat=${x.rating}`, '@bpm']
                        if (x.favorite) {
                            fields.push('@loved')
                        }
                        for (j=0; j<fields.length; j++) {
                            if (fields[j] != null) {
                                if ((fields[j].toLowerCase().search(token) != -1)) {
                                    return true;
                                }
                            }
                        }
                        return false;
                    }
                )
            }
        }
    }
    this.filter(
        function (obj) {
            for(i=0; i<search_f.length; i++) {
                x = search_f[i](obj);
                if (!x) {
                    return false;
                }
            }
            return true;
        }
    )
};

display_all_songs()();
queue_actions.reload();
update_queue_labels();
//update_suggestions();

function move_displayed_queue_element(q_element, from_index, to_index) {
    $$('queue_list').data.each(
        function (element) {
            if ((element.position >= to_index)) {
                element.position++;
            }
        }
    );
    $$('queue_list').data.each(
        function (element) {
            if ((element.position > from_index)) {
                element.position--;
            }
        }
    );
    q_element.position = to_index;
}

var preview_track_id = undefined;

webix.UIManager.removeHotKey('space');
webix.UIManager.removeHotKey('shift+space');
webix.UIManager.removeHotKey('left');
webix.UIManager.removeHotKey('right');
webix.UIManager.removeHotKey('shift+left');
webix.UIManager.removeHotKey('shift+right');
webix.UIManager.removeHotKey('tab');
webix.UIManager.removeHotKey('shift+ctrl+s');

//webix.UIManager.addHotKey("ctrl+shift+s", main_list_actions.set_as_short_list, $$('display_list'));


webix.UIManager.addHotKey("alt+r", queue_actions.reload);

webix.UIManager.addHotKey("t", queue_actions.move_selection_to_top, $$('queue_list'));
webix.UIManager.addHotKey("u", queue_actions.move_selection_up, $$('queue_list'));
webix.UIManager.addHotKey("d", queue_actions.move_selection_down, $$('queue_list'));
webix.UIManager.addHotKey("ctrl+e", queue_actions.edit_track_data, $$('queue_list'));
webix.UIManager.addHotKey("shift+backspace", queue_actions.remove_selection, $$('queue_list'));
webix.UIManager.addHotKey("ctrl+shift+enter", queue_actions.preview_last_30_seconds, $$('queue_list'));
webix.UIManager.addHotKey("shift+enter", queue_actions.preview_last_10_seconds, $$('queue_list'));
webix.UIManager.addHotKey("enter", queue_actions.preview_selection, $$('queue_list'));

webix.UIManager.addHotKey("shift+q", main_list_actions.add_selection_to_queue, $$('display_list'));
webix.UIManager.addHotKey("shift+s", main_list_actions.add_selection_to_short_list, $$('display_list'));
webix.UIManager.addHotKey("shift+ctrl+s", main_list_actions.save_shortlist_as_playlist, $$('display_list'));
webix.UIManager.addHotKey("shift+u", main_list_actions.add_selection_to_unavailable, $$('display_list'));
webix.UIManager.addHotKey("shift+a", main_list_actions.remove_selection_from_unavailable, $$('display_list'));
webix.UIManager.addHotKey("escape", main_list_actions.display_all_songs, $$('display_list'));
webix.UIManager.addHotKey("ctrl+e", main_list_actions.edit_track_data, $$('display_list'));
webix.UIManager.addHotKey("ctrl+shift+enter", main_list_actions.preview_last_30_seconds, $$('display_list'));
webix.UIManager.addHotKey("shift+enter",  main_list_actions.preview_last_10_seconds, $$('display_list'));
webix.UIManager.addHotKey("enter",  main_list_actions.preview_selected, $$('display_list'));
webix.UIManager.addHotKey("ctrl+f",  main_list_actions.filter_list, $$('display_list'));

// webix.UIManager.addHotKey("shift+q", suggestion_list_actions.add_selection_to_queue, $$('suggestion_list'));
// webix.UIManager.addHotKey("shift+s", suggestion_list_actions.add_selection_to_short_list, $$('suggestion_list'));
// webix.UIManager.addHotKey("shift+u", suggestion_list_actions.add_selection_to_unavailable, $$('suggestion_list'));
// webix.UIManager.addHotKey("shift+a", suggestion_list_actions.remove_selection_from_unavailable, $$('suggestion_list'));
// webix.UIManager.addHotKey("ctrl+e", suggestion_list_actions.edit_track_data, $$('suggestion_list'));
// webix.UIManager.addHotKey("ctrl+shift+enter",  suggestion_list_actions.preview_last_30_seconds, $$('suggestion_list'));
// webix.UIManager.addHotKey("shift+enter",  suggestion_list_actions.preview_last_10_seconds, $$('suggestion_list'));
// webix.UIManager.addHotKey("enter",  suggestion_list_actions.preview_selected, $$('suggestion_list'));
// webix.UIManager.addHotKey("ctrl+f",  suggestion_list_actions.filter_list, $$('suggestion_list'));

webix.UIManager.addHotKey("space", playback_actions.preview_pause);
webix.UIManager.addHotKey("shift+space", playback_actions.preview_stop);
webix.UIManager.addHotKey("shift+ctrl+q", playback_actions.increase_main_player_volume);
webix.UIManager.addHotKey("shift+ctrl+a", playback_actions.decrease_main_player_volume);
webix.UIManager.addHotKey("shift+ctrl+i", playback_actions.increase_precue_player_volume);
webix.UIManager.addHotKey("shift+ctrl+k", playback_actions.decrease_precue_player_volume);
webix.UIManager.addHotKey("shift+ctrl+o", playback_actions.increase_monitor_volume);
webix.UIManager.addHotKey("shift+ctrl+l", playback_actions.decrease_monitor_volume);
webix.UIManager.addHotKey("shift+left", playback_actions.preview_backward_seek_short);
webix.UIManager.addHotKey("shift+right", playback_actions.preview_forward_seek_short);
webix.UIManager.addHotKey("ctrl+shift+left", playback_actions.preview_backward_seek_long);
webix.UIManager.addHotKey("ctrl+shift+right", playback_actions.preview_forward_seek_long);

//webix.UIManager.addHotKey("escape", track_edit_actions.close_track_editor, $$('track_edit_window'));
//webix.UIManager.addHotKey("ctrl+shift+enter", track_edit_actions.play_last_30_seconds, $$('track_edit_window'));
//webix.UIManager.addHotKey("shift+enter", track_edit_actions.play_last_10_seconds, $$('track_edit_window'));
//webix.UIManager.addHotKey("enter", track_edit_actions.play_track, $$('track_edit_window'));

// webix.UIManager.addHotKey("ctrl+c", track_edit_actions.reset_waveform_zoom, $$('track_edit_window'));
// webix.UIManager.addHotKey("ctrl+x", track_edit_actions.zoom_waveform_last_10_seconds, $$('track_edit_window'));
// webix.UIManager.addHotKey("ctrl+z", track_edit_actions.zoom_waveform_first_10_seconds, $$('track_edit_window'));

// webix.UIManager.addHotKey("shift+c", track_edit_actions.set_start_marker, $$('track_edit_window'));
// webix.UIManager.addHotKey("shift+h", track_edit_actions.move_start_marker_backward_long, $$('track_edit_window'));
// webix.UIManager.addHotKey("shift+j", track_edit_actions.move_start_marker_forward_long, $$('track_edit_window'));
// webix.UIManager.addHotKey("shift+n", track_edit_actions.move_start_marker_backward_short, $$('track_edit_window'));
// webix.UIManager.addHotKey("shift+m", track_edit_actions.move_start_marker_forward_short, $$('track_edit_window'));

// webix.UIManager.addHotKey("ctrl+shift+c", track_edit_actions.set_end_marker, $$('track_edit_window'));
// webix.UIManager.addHotKey("ctrl+shift+h", track_edit_actions.move_end_marker_backward_long, $$('track_edit_window'));
// webix.UIManager.addHotKey("ctrl+shift+j", track_edit_actions.move_end_marker_forward_long, $$('track_edit_window'));
// webix.UIManager.addHotKey("ctrl+shift+n", track_edit_actions.move_end_marker_backward_short, $$('track_edit_window'));
// webix.UIManager.addHotKey("ctrl+shift+m", track_edit_actions.move_end_marker_forward_short, $$('track_edit_window'));

// webix.UIManager.addHotKey("ctrl+shift+x", track_edit_actions.zoom_waveform_last_30_seconds, $$('track_edit_window'));
// webix.UIManager.addHotKey("ctrl+shift+z", track_edit_actions.zoom_waveform_first_30_seconds, $$('track_edit_window'));



$$('display_list').attachEvent('onItemDblClick',
    function (id) {
        var id = $$('display_list').getSelectedId().id;
        preview_track_id = id;
        preview_play_track_id(id);
    }
);

$$('queue_list').attachEvent('onItemDblClick',
    function (id) {
        var id = $$('queue_list').getSelectedItem().track_id;
        preview_track_id = id;
        preview_play_track_id(id);
    }
);

webix.UIManager.addHotKey("alt+f",
    function () {
        const win = require('electron').remote.getCurrentWindow();
        win.setFullScreen(!win.isFullScreen());
    }
);

webix.UIManager.addHotKey("escape", function () {
    webix.UIManager.setFocus($$('display_list'));
}, $$('track_filter'));

webix.UIManager.addHotKey("enter", function () {
    webix.UIManager.setFocus($$('display_list'));
}, $$('track_filter'));

var filtering = false;

$$('track_filter').attachEvent('onFocus', function (x) {
    filtering=true;
});
$$('track_filter').attachEvent('onBlur', function (x) {
    filtering=false;
});

webix.UIManager.addHotKey("right", function () {
    webix.UIManager.setFocus('queue_list');
}, $$('display_list'));

webix.UIManager.addHotKey("left", function () {
    webix.UIManager.setFocus('queue_list');
}, $$('display_list'));



webix.UIManager.addHotKey("left", function () {
    webix.UIManager.setFocus($$('display_list'));
}, $$('queue_list'));

webix.UIManager.addHotKey("right", function () {
    webix.UIManager.setFocus($$('display_list'));
}, $$('queue_list'));


// webix.UIManager.addHotKey("left", function () {
//     webix.UIManager.setFocus($$('queue_list'));
// }, $$('suggestion_list'));

// webix.UIManager.addHotKey("right", function () {
//     webix.UIManager.setFocus($$('display_list'));
// }, $$('suggestion_list'));



// $$('suggestion_list').attachEvent('onFocus',
//     function (x) {
//         s = $$('queue_list').getSelectedId();
//         if (s == '') {
//             $$('queue_list').select($$('queue_list').getFirstId());
//         }
//         webix.html.addCss( $$('suggestion_list_header_row').getNode(), "focus_header");
//         webix.html.removeCss( $$('main_list_header_row').getNode(), "focus_header");
//         webix.html.removeCss( $$('queue_list_header_row').getNode(), "focus_header");
//     }
//  );


$$('queue_list').attachEvent('onFocus',
    function (x) {
        s = $$('queue_list').getSelectedId();
        if (s == '') {
            $$('queue_list').select($$('queue_list').getFirstId());
        }
        webix.html.addCss( $$('queue_list_header_row').getNode(), "focus_header");
        webix.html.removeCss( $$('main_list_header_row').getNode(), "focus_header");
        //webix.html.removeCss( $$('suggestion_list_header_row').getNode(), "focus_header");
    }
 );

$$('display_list').attachEvent('onFocus',
  function (x) {
      s = $$('display_list').getSelectedId();
      if (s == '') {
          $$('display_list').select($$('display_list').getFirstId());
      }
      webix.html.addCss($$('main_list_header_row').getNode(), "focus_header");
      webix.html.removeCss( $$('queue_list_header_row').getNode(), "focus_header");
      //webix.html.removeCss( $$('suggestion_list_header_row').getNode(), "focus_header");
  }
);

$$('display_list').attachEvent('onAfterLoad', () => {update_list_labels()})
webix.UIManager.setFocus($$('display_list'));

function checkTime(i) {
     return (i < 10) ? "0" + i : i;
 }

 function startTime() {
     var today = new Date()
     h = checkTime(today.getHours())
     m = checkTime(today.getMinutes())
     s = checkTime(today.getSeconds())
     d = checkTime(today.getDate())
     M = checkTime(today.getMonth()+1)
     Y = today.getFullYear()
    $$('calendar').define('label', `<span style="color:rgb(200,200,200)">${Y}-${M}-${d}</span> | <b>${h}:${m}</b>`)
    $$('calendar').refresh()
     t = setTimeout(function () {
         startTime()
     }, 30000);
 }
 startTime();


 function load_sessions() {
    let list_id = "sessions-list"
    $QUERY(
        `SELECT id, event_name as name, date(start_date) as date, counts.count as count
        FROM sessions JOIN (select session_id, count(track_id) as count FROM session_tracks
        GROUP BY session_id) counts ON sessions.id=counts.session_id ORDER BY date ASC`,
        function (result_list) {
            $$(list_id).clearAll()
            $$(list_id).define('data', result_list);
            $$(list_id).refresh()
        }
    )

 }

function load_playlists() {
    let list_id = "playlist-list"
    DB.get_group_list(
        function (result_list) {
            $$(list_id).clearAll()
            $$(list_id).define('data', result_list);
            $$(list_id).refresh() 
        }
    )
 
}

load_sessions()
load_playlists()
</script>
