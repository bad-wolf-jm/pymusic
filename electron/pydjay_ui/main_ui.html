<!DOCTYPE html>
<title>PYMUSIC DJ App</title>
<script src="../node_modules/webix/webix.js"></script>
<script src="../lib/progressbar.js"></script>

<script src="../web-audio/event_dispatcher.js"></script>
<script src="../web-audio/audio_context.js"></script>
<script src="../web-audio/audio_player.js"></script>
<script src="../web-audio/audio_player_base.js"></script>
<script src="../web-audio/audio_player_buffer.js"></script>
<script src="../web-audio/audio_player_file.js"></script>
<script src="../web-audio/mp3_fileinfo.js"></script>


<script src="./utils.js"></script>
<script src="./sql.js"></script>
<script src="./data.js"></script>
<script src="./data_class.js"></script>
<script src="./components/lists/track_table.js"></script>
<script src="./components/lists/track_list.js"></script>
<!-- <script src="./components/lists/main_list_display.js"></script> -->
<script src="./components/lists/queue_display.js"></script>
<script src="./components/playlist/playlist_editor.js"></script>
<script src="./components/playlist/create.js"></script>
<script src="./components/playlist/delete.js"></script>
<script src="./components/playlist/duplicate.js"></script>
<script src="./components/playlist/short_list.js"></script>
<script src="./components/playback/precue_player.js"></script>
<script src="./components/playback/main_player.js"></script>
<script src="./menu.js"></script>
<script src="./sidebar.js"></script>
<script src="./playback.js"></script>
<!-- <script src="./track_edit.js"></script> -->
<script src="./components/edit/track_editor.js"></script>
<script src="./components/edit/track_add.js"></script>
<script src="./queue.js"></script>
<script src="./actions.js"></script>
<link rel="stylesheet" href="../node_modules/webix/webix.css">
<!-- <link rel="stylesheet" href="../node_modules/webix/skins/terrace.css">-->
<link rel="stylesheet" href="../node_modules/webix/skins/contrast.css"> 
<link rel="stylesheet" href="./pymusic_style.css">


<body>
  <article id="mainArticle">
  </article>
</body>
<script type="text/javascript">
$ = require('jquery')
WaveSurfer = require("wavesurfer.js")
var WaveSurferRegions = require('wavesurfer.js/dist/plugin/wavesurfer.regions.min.js');
var path = require('path');
var dialog = require('electron').remote.dialog;

webix.ready( () => {
        pl.init_progress()
    }
)

var queue_display_template = {
    type:'line',
    css:{
        border: '0px solid #3c3c3c',
    },
    rows:[
        {
            id: 'queue_list_header_row',
            height:30,
            css:{
                'background-color':'#303030',
                border: '1px solid #3c3c3c'
             },
             rows: [
                 {height:7},
                {
                    view: 'label',
                    label: '<b>QUEUE</b>',
                    height: 20,
                    css:{
                        'padding-left':'10px',
                     }
                },
                {height:5},
            ]
        },
        {
            view:"list",
            id:'queue_list',
            css:{
                border: '1px solid #3c3c3c',
             },
            select:true,
            template: queue_element_template,
            type: { 
                height: cover_size
            },
            scroll:"y"
        }
    ]
}


function save_current_session() {
    x = webix.ui({
        view:"window",
        modal:true,
        position:"center",
        width:600,
        height:400,
        head: "SAVE CURRENT SESSION",
        body:{
            rows:[
                {height:10},
                {
                    id:'session_name',
                    view: "text",
                    value:'',
                    label:"Name:"
                },
                {
                    id:'session_location',
                    view:"text",
                    value:'',
                    label:"Location:"
                },
                {
                    id:'session_address',
                    view:"text",
                    value:'',
                    label:"Address:"
                },
                {height:30},
                {
                    cols:[
                        {},
                        {
                            view: 'button',
                            label: 'SAVE',
                            click: function () {
                                save_session($$('session_name').getValue(),
                                             $$('session_location').getValue(),
                                             $$('session_address').getValue());
                                x.hide();
                            }
                        },
                        {},
                        {
                            view: 'button',
                            label: 'CANCEL',
                            click: () => {x.hide()}
                        },
                        {}
                    ]
                },
                {height:10}
            ]
        }
    })
    session_popup.hide()
    x.show();
}

// function playback_settings() {
//     db_connection.query(
//         'SELECT wait_time FROM settings',
//         function (e, r) {
//             if (e) throw e;
//             wait_time = r[0].wait_time;
//             x = webix.ui({
//                 view:"window",
//                 modal:true,
//                 position:"center",
//                 width:600,
//                 height:400,
//                 head: "PLAYBACK SETTINGS",
//                 body:{
//                     rows:[
//                         {height:10},
//                         {
//                             id:'wait_time',
//                             view: "text",
//                             value: `${wait_time}`,
//                             labelWidth:225,
//                             label:"Delay between tracks (seconds):"
//                         },
//                         {height:30},
//                         {
//                             view: "button",
//                             type: 'icon',
//                             icon: "headphones",
//                             label: "Reset audio system",
//                             click: reset_audio

//                         },
//                         {height:30},
//                         {
//                             cols:[
//                                 {},
//                                 {
//                                     view: 'button',
//                                     label: 'APPLY',
//                                     click: function () {
//                                         db_connection.query(
//                                             `UPDATE settings SET wait_time=${parseInt($$('wait_time').getValue())}`,
//                                             function (error, x) {
//                                                 if (error) throw error;
//                                                 x.hide();
//                                             }
//                                         )
//                                         x.hide();
//                                     }
//                                 },
//                                 {},
//                                 {
//                                     view: 'button',
//                                     label: 'CANCEL',
//                                     click: () => {x.hide()}
//                                 },
//                                 {}
//                             ]
//                         },
//                         {height:10}
//                     ]
//                 }
//             })
//             x.show();
//         }
//     )
// }
var cover_size = 45
function queue_element_template(element) {
    var cover_source = null;
    if (element.cover == null) {
        cover_source = "../resources/images/default_album_cover.png"
    } else {
        cover_source = `file://${element.image_root}/${element.cover}`
    }
    return `<img style="float:left; padding-right:7px; padding-left:-3px" src="${cover_source}" height='${cover_size}' width='${cover_size}'></img>
            <div style="margin:0px; padding:0px; float:left; width:275px">
                <div class="queue_element_title"><b>${element.title}</b></div>
                <div class="queue_element_artist"><i>${element.artist}</i></div>
            </div>
            <div class="queue_element_bpm">${element.bpm} BPM</div>
            <div class="queue_element_duration">
                <b>${format_nanoseconds(element.stream_length)}</b>
            </div>`
}

var session_popup = webix.ui(
    {
        view:"popup",
        id:"session_popup",
        height:700,
        width:500,
        body:{
            rows:[
                {
                    cols: [
                        {
                            view:'label',
                            label:"<b>PLAYED SONGS</b>",
                            height:30
                        },
                        {
                            gravity:.5,
                            id: 'session_save_button',
                            view:'button',
                            label:"SAVE",
                            height:30,
                            click: save_current_session,
                        }
                    ]
                },
                {height:10},
                {
                    view:'list',
                    id:'session_list_view',
                    template: queue_element_template,
                    type: { height: cover_size  }
                }
            ]
        }
})
session_popup.hide();
$$('session_save_button').hide();
session_popup.attachEvent('onShow', function () {
    var sql = `SELECT tracks.id as track_id, session_queue.id as id, session_queue.position, tracks.title, tracks.artist,
                    tracks.album, tracks.bpm, tracks.stream_length,
                    settings.db_image_cache as image_root, tracks.cover_small as cover,
                    session_queue.position as position
             FROM
                 (tracks LEFT JOIN settings ON 1) LEFT JOIN session_queue
             ON
                 tracks.id=session_queue.track_id WHERE session_queue.status='played'
             ORDER BY session_queue.position`

    db_connection.query(sql, function (err, result) {
      if (err) throw err;
      $$('session_list_view').clearAll();
      if (result.length == 0) {
          $$('session_save_button').hide();
      } else {
          if (!queue_playing) {
              $$('session_save_button').show();
          } else {
              $$('session_save_button').hide();
          }
      }
      for(var i=0; i < result.length; i++){
          $$('session_list_view').add(result[i])
      }
    });
})

var popup = webix.ui({
    view:"popup",
    id:"skip_stop_dialog",
    height:650,
    width:400,
    body:{
        rows: [
            {
                view: 'label',
                label: '<b>SKIP SONG/STOP QUEUE</b>'
            },
            {
                cols: [
                    {
                        view:'button',
                        type:'icon',
                        icon:'stop',
                        label:'STOP QUEUE',
                        maxHeight:35,
                        click: stop_queue_now
                    },
                    {
                        view:'button',
                        type:'icon',
                        icon:'step-forward',
                        label:'SKIP SONG',
                        maxHeight:35,
                        click: skip_to_next_track
                    }
                ]
            }
        ]
    }
})
popup.hide();


main_track_table = new TrackTable()
main_menu = new TopMenu()
var main_player_interface = mpl
webix.ready(
    () => {
        main_player_interface.setRating(3)
        mpl.init()
    }
)
var datatable = webix.ui({
    css:{
            'background-color':'#515151',
            'padding':'0px',
        },
    rows:[
    {
            height:40,
            css: {
                'background-color': '#2a2a2a',
                'padding':'0px',
                'border-bottom':"2px solid #a2a2a2 !important",
            },
            cols:[
                {
                    width:15
                },
                main_menu.create_layout(),
                {
                    view: 'label',
                    id: 'queue_duration',
                    label: '<b>QUEUE DURATION:</b> 0:00',
                    height: 20,
                    css: {
                        "text-align": 'center'//,
                    }
                },
                {
                    view: 'label',
                    id:'queue_ends_at',
                    label: '<b>ENDS:</b> 0:00',
                    height: 20,
                    css: {
                        "text-align": 'center'//,
                    }
                },
                {
                    view: 'label',
                    id: 'calendar',
                    label: '<span style="color:rgb(200,200,200)">2018-01-09</span> | 0:45',
                    height: 20,
                    css: {
                        "text-align": 'right'//,
                    }
                },
                {
                    width:15
                }
            ]
        },

        main_player_interface.create_layout(),
        {
            cols:[
                sidebar_template,
                main_track_table.create_layout(),
                {
                    width:494,
                    rows: [
                        queue_display_template,
                        pl.create_layout(),
                    ]
                }
            ]
        },
    ]
});
$$('queue_stop_message').hide();


main_track_table.init()

display_all_songs()();
queue_actions.reload();
update_queue_labels();
//update_suggestions();

function move_displayed_queue_element(q_element, from_index, to_index) {
    $$('queue_list').data.each(
        function (element) {
            if ((element.position >= to_index)) {
                element.position++;
            }
        }
    );
    $$('queue_list').data.each(
        function (element) {
            if ((element.position > from_index)) {
                element.position--;
            }
        }
    );
    q_element.position = to_index;
}

var preview_track_id = undefined;

webix.UIManager.removeHotKey('space');
webix.UIManager.removeHotKey('shift+space');
webix.UIManager.removeHotKey('left');
webix.UIManager.removeHotKey('right');
webix.UIManager.removeHotKey('shift+left');
webix.UIManager.removeHotKey('shift+right');
webix.UIManager.removeHotKey('tab');
webix.UIManager.removeHotKey('shift+ctrl+s');

//webix.UIManager.addHotKey("ctrl+shift+s", main_list_actions.set_as_short_list, $$(main_track_table.track_list));


webix.UIManager.addHotKey("alt+r", queue_actions.reload);

webix.UIManager.addHotKey("t", queue_actions.move_selection_to_top, $$('queue_list'));
webix.UIManager.addHotKey("u", queue_actions.move_selection_up, $$('queue_list'));
webix.UIManager.addHotKey("d", queue_actions.move_selection_down, $$('queue_list'));
webix.UIManager.addHotKey("ctrl+e", queue_actions.edit_track_data, $$('queue_list'));
webix.UIManager.addHotKey("shift+backspace", queue_actions.remove_selection, $$('queue_list'));
webix.UIManager.addHotKey("ctrl+shift+enter", queue_actions.preview_last_30_seconds, $$('queue_list'));
webix.UIManager.addHotKey("shift+enter", queue_actions.preview_last_10_seconds, $$('queue_list'));
webix.UIManager.addHotKey("enter", queue_actions.preview_selection, $$('queue_list'));

webix.UIManager.addHotKey("shift+q", main_list_actions.add_selection_to_queue, $$(main_track_table.track_list));
webix.UIManager.addHotKey("shift+s", main_list_actions.add_selection_to_short_list, $$(main_track_table.track_list));
webix.UIManager.addHotKey("shift+ctrl+s", main_list_actions.save_shortlist_as_playlist, $$(main_track_table.track_list));
webix.UIManager.addHotKey("shift+u", main_list_actions.add_selection_to_unavailable, $$(main_track_table.track_list));
webix.UIManager.addHotKey("shift+a", main_list_actions.remove_selection_from_unavailable, $$(main_track_table.track_list));
webix.UIManager.addHotKey("escape", main_list_actions.display_all_songs, $$(main_track_table.track_list));
webix.UIManager.addHotKey("ctrl+e", main_list_actions.edit_track_data, $$(main_track_table.track_list));
webix.UIManager.addHotKey("ctrl+shift+enter", main_list_actions.preview_last_30_seconds, $$(main_track_table.track_list));
webix.UIManager.addHotKey("shift+enter",  main_list_actions.preview_last_10_seconds, $$(main_track_table.track_list));
webix.UIManager.addHotKey("enter",  main_list_actions.preview_selected, $$(main_track_table.track_list));
//webix.UIManager.addHotKey("ctrl+f",  main_list_actions.filter_list, $$(main_track_table.track_list));

webix.UIManager.addHotKey("space", playback_actions.preview_pause);
webix.UIManager.addHotKey("shift+space", playback_actions.preview_stop);
webix.UIManager.addHotKey("shift+ctrl+q", playback_actions.increase_main_player_volume);
webix.UIManager.addHotKey("shift+ctrl+a", playback_actions.decrease_main_player_volume);
webix.UIManager.addHotKey("shift+ctrl+i", playback_actions.increase_precue_player_volume);
webix.UIManager.addHotKey("shift+ctrl+k", playback_actions.decrease_precue_player_volume);
webix.UIManager.addHotKey("shift+ctrl+o", playback_actions.increase_monitor_volume);
webix.UIManager.addHotKey("shift+ctrl+l", playback_actions.decrease_monitor_volume);
webix.UIManager.addHotKey("shift+left", playback_actions.preview_backward_seek_short);
webix.UIManager.addHotKey("shift+right", playback_actions.preview_forward_seek_short);
webix.UIManager.addHotKey("ctrl+shift+left", playback_actions.preview_backward_seek_long);
webix.UIManager.addHotKey("ctrl+shift+right", playback_actions.preview_forward_seek_long);

main_track_table.on('item-selected', (track) => preview_play_track_id(track.id))

$$('queue_list').attachEvent('onItemDblClick',
    function (id) {
        var id = $$('queue_list').getSelectedItem().track_id;
        preview_track_id = id;
        preview_play_track_id(id);
    }
);

webix.UIManager.addHotKey("alt+f",
    function () {
        const win = require('electron').remote.getCurrentWindow();
        win.setFullScreen(!win.isFullScreen());
    }
);

var filtering = false;

webix.UIManager.addHotKey("right", function () {
    webix.UIManager.setFocus('queue_list');
}, $$(main_track_table.track_list));

webix.UIManager.addHotKey("left", function () {
    webix.UIManager.setFocus('queue_list');
}, $$(main_track_table.track_list));



webix.UIManager.addHotKey("left", function () {
    webix.UIManager.setFocus($$(main_track_table.track_list));
}, $$('queue_list'));

webix.UIManager.addHotKey("right", function () {
    webix.UIManager.setFocus($$(main_track_table.track_list));
}, $$('queue_list'));


$$('queue_list').attachEvent('onFocus',
    function (x) {
        s = $$('queue_list').getSelectedId();
        if (s == '') {
            $$('queue_list').select($$('queue_list').getFirstId());
        }
        webix.html.addCss( $$('queue_list_header_row').getNode(), "focus_header");
        webix.html.removeCss( $$(main_track_table.header).getNode(), "focus_header");
    }
 );


main_track_table.on('focus-in-list',
  (x) => {
      s = $$(main_track_table.track_list).getSelectedId();
      if (s == '') {
          $$(main_track_table.track_list).select($$(main_track_table.track_list).getFirstId());
      }
      webix.html.addCss($$(main_track_table.header).getNode(), "focus_header");
      webix.html.removeCss( $$('queue_list_header_row').getNode(), "focus_header");
  }
);

webix.UIManager.setFocus($$(main_track_table.track_list));

function checkTime(i) {
     return (i < 10) ? "0" + i : i;
 }

 function startTime() {
     var today = new Date()
     h = checkTime(today.getHours())
     m = checkTime(today.getMinutes())
     s = checkTime(today.getSeconds())
     d = checkTime(today.getDate())
     M = checkTime(today.getMonth()+1)
     Y = today.getFullYear()
    $$('calendar').define('label', `<span style="color:rgb(200,200,200)">${Y}-${M}-${d}</span> | <b>${h}:${m}</b>`)
    $$('calendar').refresh()
     t = setTimeout(function () {
         startTime()
     }, 30000);
 }
 startTime();


 function load_sessions() {
    let list_id = "sessions-list"
    $QUERY(
        `SELECT id, event_name as name, date(start_date) as date, counts.count as count
        FROM sessions JOIN (select session_id, count(track_id) as count FROM session_tracks
        GROUP BY session_id) counts ON sessions.id=counts.session_id ORDER BY date ASC`,
        function (result_list) {
            $$(list_id).clearAll()
            $$(list_id).define('data', result_list);
            $$(list_id).refresh()
        }
    )

 }

function load_playlists() {
    let list_id = "playlist-list"
    DB.get_group_list(
        function (result_list) {
            $$(list_id).clearAll()
            $$(list_id).define('data', result_list);
            $$(list_id).refresh() 
        }
    ) 
}

load_sessions()
load_playlists()
</script>
