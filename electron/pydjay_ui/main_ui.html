<!DOCTYPE html>
<title>PYMUSIC DJ App</title>
<script src="../node_modules/webix/webix.js"></script>
<script src="../lib/progressbar.js"></script>
<script src="./utils.js"></script>
<script src="./main_list_display.js"></script>
<script src="./queue_display.js"></script>
<script src="./sidebar.js"></script>
<script src="./playback.js"></script>
<script src="./track_edit.js"></script>
<script src="./queue.js"></script>
<script src="./sql.js"></script>
<script src="./actions.js"></script>
<link rel="stylesheet" href="../node_modules/webix/webix.css">
<link rel="stylesheet" href="../node_modules/webix/skins/terrace.css">
<link rel="stylesheet" href="../node_modules/webix/skins/contrast.css">
<!-- <link rel="stylesheet" href="../node_modules/semantic-ui/dist/semantic.min.css"> -->
<link rel="stylesheet" href="./pymusic_style.css">


<body>
  <article id="mainArticle">
  </article>
</body>
<script type="text/javascript">
$ = require('jquery')
Highcharts = require('highcharts')
var path = require('path');

var player_window = {
    height:58,
    gravity:1,
    css:{
        'background-color':'#3c3c3c',
        'padding':'0px',
        border: '1px solid #5c5c5c',
     },
    cols:[
        {
            id:'main-cover-image',
            view: 'template',
            width:58,
            height:58,
            template: ""
        },
        {width:5},
        {
            rows:[
                {height:7},
                {
                    cols: [
                        {
                            rows: [
                                {
                                    id:'main-title',
                                    view: 'label',
                                    css: {
                                        'text-align':'left',
                                        'text-transform':'uppercase',
                                        'font-weight':'bold'
                                    },
                                    label: 'Title Of Song', height:20
                                },
                                {
                                    id:'main-artist',
                                    view: 'label',
                                    css: {
                                        'text-align':'left',
                                        'white-space':'nowrap',
                                        'overflow': 'hidden',
                                        'text-overflow': 'ellipsis'
                                    },
                                    label: 'Artist - Album',
                                    height:20
                                }
                            ]
                        },
                        {
                            id:'main_track_time',
                            view: 'label',
                            css: {
                                'text-align':'right',
                                'font-size':'20px',
                                'font-weight':800
                            },
                            label: '-00:00',
                            height:15,
                            width:75
                        },
                        {width:5}
                    ]
                },
                {height:2},
                {cols:[
                    {width:2},
                    {
                        height:5,
                        css:{margin:0, padding:0, border: '0px solid #3c3c3c'},
                        template:'<div id="main-player-progress" style="border: \'0px solid black\'; width:100%; height:100%; position:relative; top:0%; transform: translateY(-150%)"></div>'
                    },
                    {width:7}
                ]}
            ]
        }
    ]
}
var main_player_progress =undefined;
$(document).ready( () => {
    main_player_progress = new ProgressBar.Line('#main-player-progress',
    {
     strokeWidth: 1,
     easing: 'easeInOut',
     duration: 50,
     color: '#5a5a5a',
     trailColor: '#eee',
     trailWidth: 1,
     svgStyle: {width: '100%', height: '100%'}});
    main_player_progress.animate(0);
});

var preview_player_window = {
    height:190,
    gravity:1,
    css:{
        'background-color':'#6c6c6c',
        'padding':'1px',
        border: '1px solid #3c3c3c'
     },
     rows: [{
            cols:[
                {
                    id:'preview-cover-image',
                    view: 'template',
                    width:58,
                    height:58,
                    template: "FOO"
                },
                {width:10},
                {
                    rows:[
                        {},
                        {
                            id:'preview_title',
                            view: 'label',
                            css: {
                                'text-align':'left',
                                'font-weight':'bold',
                                'text-transform':'uppercase',
                                'white-space':'nowrap',
                                'overflow': 'hidden',
                                'text-overflow': 'ellipsis'
                            },
                            label: 'Title Of Song',
                            height:20
                        },
                        {
                            id:'preview_artist',
                            view: 'label',
                            css: {
                                'text-align':'left',
                                'white-space':'nowrap',
                                'overflow': 'hidden',
                                'text-overflow': 'ellipsis'
                            },
                            label: 'Artist - Album',
                            height:20
                        },
                        {}
                    ]
                },
                {width:10}
            ]
        },
        {height: 5},
        {
            height:5,
            template:'<div id="preview-progress" style="margin:0px; padding:0px; width:100%; height:100%; position:relative; top:0%; left:0%; transform: translateY(-200%)"></div>'
        },
        {height: 3},
        {cols:[
            {
                id:'preview_time',
                view: 'label',
                css:{
                    'text-align':'left',
                    'text-transform':'uppercase'
                },
                label: '0:00',
                height:20
            },
            {},
            {
                id:'preview_length',
                view: 'label',
                css:{'text-align':'right'},
                label: '0:00',
                height:20
            }

        ]},
        {height:15},
        {
            rows: [
                {
                    cols: [
                        {width: 10},
                        {
                            id:'preview_play_last_30_seconds_button',
                            view:'button',
                            label: 'LAST 30 SECS',
                            click : function () {
                                if (preview_track_id != undefined) {
                                    preview_play_track_id(preview_track_id, -30000000000);
                                }
                                webix.UIManager.setFocus($$('track_edit_window'));
                            }
                        },
                        {width:10},
                        {
                            id:'preview_play_last_10_seconds_button',
                            view:'button',
                            label: 'LAST 10 SECS',
                            click : function () {
                                if (preview_track_id != undefined) {
                                    preview_play_track_id(preview_track_id, -10000000000);
                                }
                                webix.UIManager.setFocus($$('track_edit_window'));
                            }
                        },
                        {width: 10},
                    ]
                },
                {height:5},
                {
                    cols: [
                        {width: 10},
                        {
                            id:'preview_play_button',
                            view:'button',
                            label:'PLAY/PAUSE',
                            click : function () {
                                preview_pause();
                            }
                        },
                        {width:10},
                        {
                            id:'preview_stop_button',
                            view:'button',
                            label:'STOP',
                            click : function () {
                                preview_stop();
                            }

                        },
                        {width: 10},
                    ]
                },
            ]
        },
        {}
    ]
}

var preview_seek = undefined;
webix.ready( () => {
    preview_seek = new ProgressBar.Line('#preview-progress',
    {
        strokeWidth: 1,
        duration: 50,
        color: '#5a5a5a',
        trailColor: '#eee',
        trailWidth: 1,
        svgStyle: {width: '100%', height: '100%'}
    }
 );
    preview_seek.animate(0);
});

var track_data_edit_window = webix.ui({
    id: "track_edit_window",
    view: "window",
    modal: true,
    position: "center",
    width: 1275,
    height: 700,
    head: "EDIT TRACK DATA",
    body:{
        rows:[
            {height:30},
            {
                cols:[
                    {width:20},
                    {
                        id:'main-cover-image-edit',
                        view: 'template',
                        width:128,
                        height:128,
                        template: "FOO"
                    },
                    {width:20},
                    {
                        rows:[
                            {height:7},
                            {
                                cols: [
                                    {
                                        rows: [
                                            {
                                                id:'main-title-edit',
                                                view: 'label',
                                                css: {
                                                    'text-align': 'left',
                                                    'text-transform': 'uppercase',
                                                    'font-weight': 'bold',
                                                    'font-size': '20px'
                                                },
                                                label: 'Title Of Song',
                                                height:30
                                            },
                                            {height:5},
                                            {
                                                id:'main-artist-edit',
                                                view: 'label',
                                                css: {
                                                    'text-align':'left',
                                                    'font-size': '20px',
                                                    'color': '#bfbfbf'
                                                },
                                                label: 'Artist',
                                                height:30
                                            },
                                            {},
                                            {
                                                id:'track-data',
                                                view: 'label',
                                                css: {
                                                    'text-align':'left',
                                                    'font-size':'20px'
                                                },
                                                label: 'length - BPM',
                                                height:30
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    {width:20}
                ]
            },
            {height:50},
            {
                cols: [
                    {
                        id:'edit_zoom_first_10_seconds_button',
                        view:'button',
                        type:'icon',
                        label: 'FIRST 10 SECONDS',
                        click : function () {
                            track_edit_waveform.xAxis[0].setExtremes(0, 10000000000, true, false);
                            webix.UIManager.setFocus($$('track_edit_window'));
                        }
                    },
                    {
                        id:'edit_zoom_first_30_seconds_button',
                        view:'button',
                        type:'icon',
                        label: 'FIRST 30 SECONDS',
                        click : function () {
                            track_edit_waveform.xAxis[0].setExtremes(0, 30000000000, true, false);
                            webix.UIManager.setFocus($$('track_edit_window'));
                        }
                    },
                    {},
                    {
                        id:'edit_reset_zoom_button',
                        view:'button',
                        type:'icon',
                        label: 'RESET',
                        click : function () {
                            track_edit_waveform.xAxis[0].setExtremes(0, track_length_edit, true, false);
                            webix.UIManager.setFocus($$('track_edit_window'));
                        }
                    },
                    {},
                    {
                        id:'edit_zoom_last_30_seconds_button',
                        view:'button',
                        type:'icon',
                        label: 'LAST 30 SECONDS',
                        click : function () {
                            track_edit_waveform.xAxis[0].setExtremes(track_length_edit - 30000000000, track_length_edit, true, false);
                            webix.UIManager.setFocus($$('track_edit_window'));
                        }
                    },
                    {
                        id:'edit_zoom_last_10_seconds_button',
                        view:'button',
                        type:'icon',
                        label: 'LAST 10 SECONDS',
                        click : function () {
                            track_edit_waveform.xAxis[0].setExtremes(track_length_edit - 10000000000, track_length_edit, true, false);
                            webix.UIManager.setFocus($$('track_edit_window'));
                        }
                    }
                ]
            },
            {
                cols:[
                    {width:20},
                    {
                        height:175,
                        css:{
                            margin:0,
                            padding:0,
                            border: '0px solid #3c3c3c'
                        },
                        template:'<div id="track-waveform" style="border: \'0px solid black\'; width:100%; height:100%; position:relative; top:0%;"></div>'
                    },
                    {width:20}
                ]
            },
            {height:30},
            {
                cols: [
                    {width:30},
                    {
                        id:'edit_play_button',
                        view:'button',
                        label: 'PLAY FULL TRACK',
                        click : function () {
                            preview_play_track_id(track_edited.id, stream_start_edit, stream_end_edit);
                            webix.UIManager.setFocus($$('track_edit_window'));
                        }
                    },
                    {
                        id:'edit_play_last_30_seconds_button',
                        view:'button',
                        label: 'LAST 30 SECONDS',
                        click : function () {
                            preview_play_track_id(track_edited.id, -30000000000, stream_end_edit);
                            webix.UIManager.setFocus($$('track_edit_window'));
                        }
                    },
                    {
                        id:'edit_play_last_10_seconds_button',
                        view:'button',
                        label: 'LAST 10 SECONDS',
                        click : function () {
                            preview_play_track_id(track_edited.id, -10000000000, stream_end_edit);
                            webix.UIManager.setFocus($$('track_edit_window'));
                        }
                    },
                    {},
                    {
                        id:'edit_stop_button',
                        view:'button',
                        label: 'STOP',
                        click : function () {
                            preview_stop();
                            webix.UIManager.setFocus($$('track_edit_window'));
                        }
                    },
                    {width:30}
                ]
            },
            {height:60},
            {
                cols:[
                    {width:30},
                    {
                        view: 'button',
                        label: 'APPLY',
                        click: function () {
                            save_new_track_info();
                        }
                    },
                    {},
                    {
                        view: 'button',
                        label: 'CANCEL',
                        click: () => {
                            preview_stop();
                            track_data_edit_window.hide()
                        }
                    },
                    {width:30}
                ]
            },
            {height:10}
        ]
    }
})
track_data_edit_window.hide();
track_data_edit_window.attachEvent(
    'onShow',
    function () {
        if (track_edit_waveform == undefined) {
            create_waveform_visualizer();
        }
        track_edit_waveform.xAxis[0].removePlotLine('position-marker');
        track_edit_waveform.xAxis[0].addPlotLine({
            color:'#FF0000',
            width: 2,
            zIndex: 10,
            value: 0,
            id: 'position-marker'});
        preview_stop()
    }
)

var track_edit_waveform = undefined;
function create_waveform_visualizer () {
    track_edit_waveform = new Highcharts.chart({

        chart: {
            renderTo: 'track-waveform',
            type: 'spline',
            zoomType:'x',
            spacingLeft:0,
            spacingBottom:0,
            backgroundColor: '#3c3c3c',
            plotBackgroundColor: '#3c3c3c',
            plotBorderWidth: 0,
            events: {
                redraw: function() {
                    webix.UIManager.setFocus($$('track_edit_window'));
                }
            },
            resetZoomButton: {
                theme: {
                    display: 'none'
                }
            }
        },
        tooltip: { enabled: false },
        yAxis: {title: {text: ''},
        labels: {enabled: false},
        tickPositioner: function () {
                    var maxDeviation = Math.max(Math.abs(this.dataMax), Math.abs(this.dataMin));
                    var halfMaxDeviation = Math.ceil(maxDeviation / 2);
                    return [-maxDeviation, -halfMaxDeviation, 0, halfMaxDeviation, maxDeviation];
                    }},
        xAxis: {title: {text: ''}, labels: {enabled: true}},
        legend: {enabled: false},
        title: {text: ''},
        plotOptions: {
            spline: {
                marker: {
                    enabled: false
                }
            }
        },

        series: [{
            name: '',
            states: {hover: {enabled: false}},
            data: []
        }]
    });
}

function save_current_session() {
    x = webix.ui({
        view:"window",
        modal:true,
        position:"center",
        width:600,
        height:400,
        head: "SAVE CURRENT SESSION",
        body:{
            rows:[
                {height:10},
                {
                    id:'session_name',
                    view: "text",
                    value:'',
                    label:"Name:"
                },
                {
                    id:'session_location',
                    view:"text",
                    value:'',
                    label:"Location:"
                },
                {
                    id:'session_address',
                    view:"text",
                    value:'',
                    label:"Address:"
                },
                {height:30},
                {
                    cols:[
                        {},
                        {
                            view: 'button',
                            label: 'SAVE',
                            click: function () {
                                save_session($$('session_name').getValue(),
                                             $$('session_location').getValue(),
                                             $$('session_address').getValue());
                                x.hide();
                            }
                        },
                        {},
                        {
                            view: 'button',
                            label: 'CANCEL',
                            click: () => {x.hide()}
                        },
                        {}
                    ]
                },
                {height:10}
            ]
        }
    })
    session_popup.hide()
    x.show();
}

function playback_settings() {
    db_connection.query(
        'SELECT wait_time FROM settings',
        function (e, r) {
            if (e) throw e;
            wait_time = r[0].wait_time;
            x = webix.ui({
                view:"window",
                modal:true,
                position:"center",
                width:600,
                height:400,
                head: "PLAYBACK SETTINGS",
                body:{
                    rows:[
                        {height:10},
                        {
                            id:'wait_time',
                            view: "text",
                            value: `${wait_time}`,
                            labelWidth:225,
                            label:"Delay between tracks (seconds):"
                        },
                        {height:30},
                        {
                            cols:[
                                {},
                                {
                                    view: 'button',
                                    label: 'APPLY',
                                    click: function () {
                                        db_connection.query(
                                            `UPDATE settings SET wait_time=${parseInt($$('wait_time').getValue())}`,
                                            function (error, x) {
                                                if (error) throw error;
                                                x.hide();
                                            }
                                        )
                                        x.hide();
                                    }
                                },
                                {},
                                {
                                    view: 'button',
                                    label: 'CANCEL',
                                    click: () => {x.hide()}
                                },
                                {}
                            ]
                        },
                        {height:10}
                    ]
                }
            })
            x.show();
        }
    )
}

main_list_display_template.gravity = 2.25;
var session_popup = webix.ui(
    {
        view:"popup",
        id:"session_popup",
        height:700,
        width:500,
        body:{
            rows:[
                {
                    cols: [
                        {
                            view:'label',
                            label:"<b>PLAYED SONGS</b>",
                            height:30
                        },
                        {
                            gravity:.5,
                            id: 'session_save_button',
                            view:'button',
                            label:"SAVE",
                            height:30,
                            click: save_current_session,
                        }
                    ]
                },
                {height:10},
                {
                    view:'list',
                    id:'session_list_view',
                    template: queue_element_template,
                    type: { height: cover_size  }
                }
            ]
        }
})
session_popup.hide();
$$('session_save_button').hide();
session_popup.attachEvent('onShow', function () {
    var sql = `SELECT tracks.id as track_id, session_queue.id as id, session_queue.position, tracks.title, tracks.artist,
                    tracks.album, tracks.bpm, tracks.stream_length,
                    settings.db_image_cache as image_root, tracks.cover_small as cover,
                    session_queue.position as position
             FROM
                 (tracks LEFT JOIN settings ON 1) LEFT JOIN session_queue
             ON
                 tracks.id=session_queue.track_id WHERE session_queue.status='played'
             ORDER BY session_queue.position`

    db_connection.query(sql, function (err, result) {
      if (err) throw err;
      $$('session_list_view').clearAll();
      if (result.length == 0) {
          $$('session_save_button').hide();
      } else {
          if (!queue_playing) {
              $$('session_save_button').show();
          } else {
              $$('session_save_button').hide();
          }
      }
      for(var i=0; i < result.length; i++){
          $$('session_list_view').add(result[i])
      }
    });
})



var popup = webix.ui({
    view:"popup",
    id:"skip_stop_dialog",
    height:650,
    width:400,
    body:{
        rows: [
            {
                view: 'label',
                label: '<b>SKIP SONG/STOP QUEUE</b>'
            },
            {
                cols: [
                    {
                        view:'button',
                        type:'icon',
                        icon:'stop',
                        label:'STOP QUEUE',
                        maxHeight:35,
                        click: stop_queue_now
                    },
                    {
                        view:'button',
                        type:'icon',
                        icon:'step-forward',
                        label:'SKIP SONG',
                        maxHeight:35,
                        click: skip_to_next_track
                    }
                ]
            }
        ]
    }
})
popup.hide();

var datatable = webix.ui({
    type:"line",
    rows:[
        {
            css:{
                'background-color':'#515151',
                'padding':'0px',
                'border-bottom': "1px solid #CCCCCC"
            },
            cols:[
                {
                    cols:[
                        {
                            id:'main-player-volume',
                            view:'button',
                            type:'icon',
                            icon:'volume-up',
                            label:'100%',
                            width:75
                        },
                        {
                            id:'monitor-volume',
                            view:'button',
                            type:'icon',
                            icon:'volume-control-phone',
                            label:'100%',
                            width:75
                        },
                        {
                            id:'precue-player-volume',
                            view:'button',
                            type:'icon',
                            icon:'headphones',
                            label:'100%',
                            width:75
                        },
                        {},
                        {
                            gravity:.5,
                            view:'button',
                            type:'icon',
                            icon:'list',
                            label:'SESSION',
                            height:25,
                            popup:'session_popup'
                        }
                    ]
                },
                player_window,
        {
            cols:[
                {
                    width:250,
                    cols:[
                        {width:7},
                        {
                            gravity:.5,
                            view:'template',
                            id: 'queue_stop_message',
                            css: {
                                'text-align':'center',
                                'vertical-align': 'middle',
                                color: '#fbbbbbb',
                                'background-color': '#870053'
                            },
                            template:'<span style="vertical-align:bottom"><b>Queue will stop after this song</b></span>',
                            maxHeight:35
                        },
                        {width:15}
                    ]
                },
                {
                    gravity:.5,
                    id:'start-stop-button',
                    view:'button',
                    type:'icon',
                    icon:'play',
                    label:'START',
                    click: start_queue,
                    maxHeight:35
                },
                {
                    gravity:.5,
                    view:'button',
                    type:'icon',
                    icon:'step-forward',
                    label:'SKIP/STOP',
                    popup: "skip_stop_dialog",
                    maxHeight:35
                },
                {
                    gravity:.5,
                    view:'button',
                    type:'icon',
                    icon:'cog',
                    label:'SETTINGS',
                    click: playback_settings,
                    maxHeight:35
                }
            ]
        }]},
        {
            type:"line",
            cols:[
                sidebar_template,
                main_list_display_template,
                {
                    width:494,
                    rows: [
                        queue_display_template,
                        {
                            height:5,
                            css: {
                                'background-color': '#3c3c3c',
                                'border-color':"0px solid #3c3c3c"
                            }
                        },
                        preview_player_window
                    ]
                }
            ]
        }
    ]
});
$$('queue_stop_message').hide();

$$("display_list").filterByAll = function () {
    var text = $$('track_filter').getValue()
    var i=0;
    search_tokens = text.split(' ')
    search_f = [];
    for (var i=0; i<search_tokens.length; i++) {
        let token = search_tokens[i];
        if (token.length > 0) {
            if (search_tokens[i].startsWith('@bpm<')) {
                let x = parseInt(search_tokens[i].split('<')[1]);
                if (!isNaN(x)) {
                    search_f.push(
                        function (obj) {
                            return obj.bpm <= x;
                        }
                    )
                } else {
                    search_f.push( (x) => {return true} )
                }
            } else if (search_tokens[i].startsWith('@bpm>')) {
                let x = parseInt(search_tokens[i].split('>')[1]);
                if (!isNaN(x)) {
                    search_f.push(
                        function (obj) {
                            return (obj.bpm >= x);
                        }
                    )
                } else {
                    search_f.push( (x) => {return true} )
                }
            } else if (search_tokens[i].startsWith('@bpm~')) {
                let x = parseInt(search_tokens[i].split('~')[1]);
                if (!isNaN(x)) {
                    search_f.push(
                        function (obj) {
                            return (obj.bpm < x*1.2) && (obj.bpm > x*0.9) ;
                        }
                    )
                } else {
                    search_f.push( (x) => {return true} )
                }
            } else {
                search_f.push(
                    function (x) {
                        fields = [x.title, x.artist, x.genre, `@rat=${x.rating}`, '@bpm']
                        if (x.favorite) {
                            fields.push('@loved')
                        }
                        for (j=0; j<fields.length; j++) {
                            if (fields[j] != null) {
                                if ((fields[j].toLowerCase().search(token) != -1)) {
                                    return true;
                                }
                            }
                        }
                        return false;
                    }
                )
            }
        }
    }
    this.filter(
        function (obj) {
            for(i=0; i<search_f.length; i++) {
                x = search_f[i](obj);
                if (!x) {
                    return false;
                }
            }
            return true;
        }
    )
};

display_all_songs()();
queue_actions.reload();
update_queue_labels();

function move_displayed_queue_element(q_element, from_index, to_index) {
    $$('queue_list').data.each(
        function (element) {
            if ((element.position >= to_index)) {
                element.position++;
            }
        }
    );
    $$('queue_list').data.each(
        function (element) {
            if ((element.position > from_index)) {
                element.position--;
            }
        }
    );
    q_element.position = to_index;
}

var preview_track_id = undefined;

webix.UIManager.removeHotKey('space');
webix.UIManager.removeHotKey('shift+space');
webix.UIManager.removeHotKey('left');
webix.UIManager.removeHotKey('right');
webix.UIManager.removeHotKey('shift+left');
webix.UIManager.removeHotKey('shift+right');
webix.UIManager.removeHotKey('tab');

webix.UIManager.addHotKey("alt+r", queue_actions.reload);
webix.UIManager.addHotKey("t", queue_actions.move_selection_to_top, $$('queue_list'));
webix.UIManager.addHotKey("u", queue_actions.move_selection_up, $$('queue_list'));
webix.UIManager.addHotKey("d", queue_actions.move_selection_down, $$('queue_list'));
webix.UIManager.addHotKey("ctrl+e", queue_actions.edit_track_data, $$('queue_list'));
webix.UIManager.addHotKey("shift+backspace", queue_actions.remove_selection, $$('queue_list'));
webix.UIManager.addHotKey("ctrl+shift+enter", queue_actions.preview_last_30_seconds, $$('queue_list'));
webix.UIManager.addHotKey("shift+enter", queue_actions.preview_last_10_seconds, $$('queue_list'));
webix.UIManager.addHotKey("enter", queue_actions.preview_selection, $$('queue_list'));

webix.UIManager.addHotKey("shift+q", main_list_actions.add_selection_to_queue, $$('display_list'));
webix.UIManager.addHotKey("shift+s", main_list_actions.add_selection_to_short_list, $$('display_list'));
webix.UIManager.addHotKey("shift+u", main_list_actions.add_selection_to_unavailable, $$('display_list'));
webix.UIManager.addHotKey("shift+a", main_list_actions.remove_selection_to_unavavilable, $$('display_list'));
webix.UIManager.addHotKey("escape", main_list_actions.display_all_songs, $$('display_list'));
webix.UIManager.addHotKey("ctrl+e", main_list_actions.edit_track_data, $$('display_list'));
webix.UIManager.addHotKey("ctrl+shift+enter",  main_list_actions.preview_last_30_seconds, $$('display_list'));
webix.UIManager.addHotKey("shift+enter",  main_list_actions.preview_last_10_seconds, $$('display_list'));
webix.UIManager.addHotKey("enter",  main_list_actions.preview_selected, $$('display_list'));
webix.UIManager.addHotKey("ctrl+f",  main_list_actions.filter_list, $$('display_list'));

webix.UIManager.addHotKey("space", playback_actions.preview_pause);
webix.UIManager.addHotKey("shift+space", playback_actions.preview_stop);
webix.UIManager.addHotKey("shift+ctrl+q", playback_actions.increase_main_player_volume);
webix.UIManager.addHotKey("shift+ctrl+a", playback_actions.decrease_main_player_volume);
webix.UIManager.addHotKey("shift+ctrl+i", playback_actions.increase_precue_player_volume);
webix.UIManager.addHotKey("shift+ctrl+k", playback_actions.decrease_precue_player_volume);
webix.UIManager.addHotKey("shift+ctrl+o", playback_actions.increase_monitor_volume);
webix.UIManager.addHotKey("shift+ctrl+l", playback_actions.decrease_monitor_volume);
webix.UIManager.addHotKey("shift+left", playback_actions.preview_backward_seek_short);
webix.UIManager.addHotKey("shift+right", playback_actions.preview_forward_seek_short);
webix.UIManager.addHotKey("ctrl+shift+left", playback_actions.preview_backward_seek_long);
webix.UIManager.addHotKey("ctrl+shift+right", playback_actions.preview_forward_seek_long);

webix.UIManager.addHotKey("escape", track_edit_actions.close_track_editor, $$('track_edit_window'));
webix.UIManager.addHotKey("ctrl+shift+enter", track_edit_actions.play_last_30_seconds, $$('track_edit_window'));
webix.UIManager.addHotKey("shift+enter", track_edit_actions.play_last_10_seconds, $$('track_edit_window'));
webix.UIManager.addHotKey("enter", track_edit_actions.play_track, $$('track_edit_window'));

webix.UIManager.addHotKey("ctrl+c", track_edit_actions.reset_waveform_zoom, $$('track_edit_window'));
webix.UIManager.addHotKey("ctrl+x", track_edit_actions.zoom_waveform_last_10_seconds, $$('track_edit_window'));
webix.UIManager.addHotKey("ctrl+z", track_edit_actions.zoom_waveform_first_10_seconds, $$('track_edit_window'));

webix.UIManager.addHotKey("shift+c", track_edit_actions.set_start_marker, $$('track_edit_window'));
webix.UIManager.addHotKey("shift+h", track_edit_actions.move_start_marker_backward_long, $$('track_edit_window'));
webix.UIManager.addHotKey("shift+j", track_edit_actions.move_start_marker_forward_long, $$('track_edit_window'));
webix.UIManager.addHotKey("shift+n", track_edit_actions.move_start_marker_backward_short, $$('track_edit_window'));
webix.UIManager.addHotKey("shift+m", track_edit_actions.move_start_marker_forward_short, $$('track_edit_window'));

webix.UIManager.addHotKey("ctrl+shift+c", track_edit_actions.set_end_marker, $$('track_edit_window'));
webix.UIManager.addHotKey("ctrl+shift+h", track_edit_actions.move_end_marker_backward_long, $$('track_edit_window'));
webix.UIManager.addHotKey("ctrl+shift+j", track_edit_actions.move_end_marker_forward_long, $$('track_edit_window'));
webix.UIManager.addHotKey("ctrl+shift+n", track_edit_actions.move_end_marker_backward_short, $$('track_edit_window'));
webix.UIManager.addHotKey("ctrl+shift+m", track_edit_actions.move_end_marker_forward_short, $$('track_edit_window'));

webix.UIManager.addHotKey("ctrl+shift+x", track_edit_actions.zoom_waveform_last_30_seconds, $$('track_edit_window'));
webix.UIManager.addHotKey("ctrl+shift+z", track_edit_actions.zoom_waveform_first_30_seconds, $$('track_edit_window'));


$$('display_list').attachEvent('onItemDblClick',
    function (id) {
        var id = $$('display_list').getSelectedId().id;
        preview_track_id = id;
        preview_play_track_id(id);
    }
);

$$('queue_list').attachEvent('onItemDblClick',
    function (id) {
        var id = $$('queue_list').getSelectedItem().track_id;
        preview_track_id = id;
        preview_play_track_id(id);
    }
);

webix.UIManager.addHotKey("alt+f",
    function () {
        const win = require('electron').remote.getCurrentWindow();
        win.setFullScreen(!win.isFullScreen());
    }
);

webix.UIManager.addHotKey("escape", function () {
    webix.UIManager.setFocus($$('display_list'));
}, $$('track_filter'));

webix.UIManager.addHotKey("enter", function () {
    webix.UIManager.setFocus($$('display_list'));
}, $$('track_filter'));

var filtering = false;

$$('track_filter').attachEvent('onFocus', function (x) {
    filtering=true;
});
$$('track_filter').attachEvent('onBlur', function (x) {
    filtering=false;
});

webix.UIManager.addHotKey("right", function () {
    webix.UIManager.setFocus('queue_list');
}, $$('display_list'));

webix.UIManager.addHotKey("left", function () {
    webix.UIManager.setFocus($$('display_list'));
}, $$('queue_list'));

$$('queue_list').attachEvent('onFocus',
    function (x) {
        s = $$('queue_list').getSelectedId();
        if (s == '') {
            $$('queue_list').select($$('queue_list').getFirstId());
        }
        webix.html.addCss( $$('queue_list_header_row').getNode(), "focus_header");
        webix.html.removeCss( $$('main_list_header_row').getNode(), "focus_header");
    }
 );

$$('display_list').attachEvent('onFocus',
  function (x) {
      s = $$('display_list').getSelectedId();
      if (s == '') {
          $$('display_list').select($$('display_list').getFirstId());
      }
      webix.html.addCss($$('main_list_header_row').getNode(), "focus_header");
      webix.html.removeCss( $$('queue_list_header_row').getNode(), "focus_header");
  }
);

$$('display_list').attachEvent('onFocus',
  function (x) {
      webix.html.addCss( $$('main_list_header_row').getNode(), "focus_header");
      webix.html.removeCss( $$('queue_list_header_row').getNode(), "focus_header");
  }
);

$$('display_list').attachEvent('onAfterLoad', () => {update_list_labels()})
webix.UIManager.setFocus($$('display_list'));



// function () {
//     preview_stop();
//     track_data_edit_window.hide()
// }, $$('track_edit_window'));

// function () {
//     preview_play_track_id(track_edited.id, -30000000000, stream_end_edit);
// }, $$('track_edit_window'));

// function () {
//     preview_play_track_id(track_edited.id, -10000000000, stream_end_edit);
// }, $$('track_edit_window'));

// function () {
//     preview_play_track_id(track_edited.id, stream_start_edit, stream_end_edit);
// }, $$('track_edit_window'));

// function () {
//     set_start_marker_to_current_time();
// }, $$('track_edit_window'));

// function () {
//     set_end_marker_to_current_time();
// }, $$('track_edit_window'));

// function () {
//     set_start_marker(stream_start_edit - 1000000000);
// }, $$('track_edit_window'));

// function () {
//     set_end_marker(stream_end_edit - 1000000000);
// }, $$('track_edit_window'));

// function () {
//     set_start_marker(stream_start_edit + 1000000000);
// }, $$('track_edit_window'));

// function () {
//     set_end_marker(stream_end_edit + 1000000000);
// }, $$('track_edit_window'));


// function () {
//     set_start_marker(stream_start_edit - 1000000000);
// }, $$('track_edit_window'));

// function () {
//     set_end_marker(stream_end_edit - 1000000000);
// }, $$('track_edit_window'));

// function () {
//     set_start_marker(stream_start_edit + 1000000000);
// }, $$('track_edit_window'));

// function () {
//     set_end_marker(stream_end_edit + 1000000000);
// }, $$('track_edit_window'));


// webix.UIManager.addHotKey("shift+n",  track_edit_actions. ,$$('track_edit_window'));
// function () {
//     set_start_marker(stream_start_edit - 100000000);
// }, $$('track_edit_window'));
//
// webix.UIManager.addHotKey("ctrl+shift+n",  track_edit_actions. ,$$('track_edit_window'));
// function () {
//     set_end_marker(stream_end_edit - 100000000);
// }, $$('track_edit_window'));
//
// webix.UIManager.addHotKey("shift+m",  track_edit_actions. ,$$('track_edit_window'));
// function () {
//     set_start_marker(stream_start_edit + 100000000);
// }, $$('track_edit_window'));
//
// webix.UIManager.addHotKey("ctrl+shift+m",  track_edit_actions. ,$$('track_edit_window'));
// function () {
//     set_end_marker(stream_end_edit + 100000000);
// }, $$('track_edit_window'));

// function () {
//     track_edit_waveform.xAxis[0].setExtremes(0, track_length_edit, true, false);
//     webix.UIManager.setFocus($$('track_edit_window'));
// }, $$('track_edit_window'));

// function () {
//     track_edit_waveform.xAxis[0].setExtremes(track_length_edit - 10000000000, track_length_edit, true, false);
//     webix.UIManager.setFocus($$('track_edit_window'));
// }, $$('track_edit_window'));

// function () {
//     track_edit_waveform.xAxis[0].setExtremes(track_length_edit - 30000000000, track_length_edit, true, false);
//     webix.UIManager.setFocus($$('track_edit_window'));
// }, $$('track_edit_window'));

// function () {
//     track_edit_waveform.xAxis[0].setExtremes(0, 10000000000, true, false);
//     webix.UIManager.setFocus($$('track_edit_window'));
// }, $$('track_edit_window'));

// function () {
//     track_edit_waveform.xAxis[0].setExtremes(0, 30000000000, true, false);
//     webix.UIManager.setFocus($$('track_edit_window'));
// }, $$('track_edit_window'));



// function () {
//     var id = $$('display_list').getSelectedId().id;
//     edit_track_data(id);
// }, $$('display_list'));


// function () {
//     selected_queue_element = $$('queue_list').getSelectedItem();
//     selected_queue_element_position = $$('queue_list').getSelectedItem().position;
//     edit_track_data(selected_queue_element.track_id);
// }, $$('queue_list'));



// function () {
//     var id = $$('display_list').getSelectedId().id;
//     preview_track_id = id;
//     preview_play_track_id(id, -30000000000);
// }, $$('display_list'));

// function () {
//     var id = $$('display_list').getSelectedId().id;
//     preview_track_id = id;
//     preview_play_track_id(id, -10000000000);
// }, $$('display_list'));


// function () {
//     var id = $$('display_list').getSelectedId().id;
//     preview_track_id = id;
//     preview_play_track_id(id);
// }, $$('display_list'));


//
// function () {
//     $$('track_filter').focus();
// }, $$('display_list'));


// function () {
//     display_all_songs()();
// }, $$('display_list'));




// function () {
//     var id = $$('display_list').getSelectedId().id;
//     add_id_to_queue(id,
//         function () {
//             sql = `SELECT tracks.id as track_id, session_queue.position, tracks.title, tracks.artist, tracks.album, tracks.bpm,
//                    tracks.stream_length, settings.db_image_cache as image_root, tracks.cover_small as cover, session_queue.position as position
//                    FROM (tracks LEFT JOIN settings ON 1) LEFT JOIN session_queue ON tracks.id=session_queue.track_id
//                    WHERE session_queue.status='pending' AND session_queue.track_id=${id} ORDER BY session_queue.position`;
//             db_connection.query(sql,
//                 function (err, result) {
//                     if (err) throw err;
//                     $$('queue_list').add(result[0]);
//                     $$('display_list').addRowCss(id, 'unavailable_track');
//                     update_queue_labels();
//                 }
//             );
//         }
//     )
// }, $$('display_list'));


// function () {
//     var id = $$('display_list').getSelectedId().id;
//     sql = `SELECT 1 FROM short_listed_tracks WHERE track_id=${id} LIMIT 1`;
//     db_connection.query(sql,
//         function (err, result){
//             if (result.length == 0){
//                 insert_sql = `INSERT INTO short_listed_tracks (track_id) VALUES (${id})`;
//                 db_connection.query(insert_sql, function(error, result){
//                 });
//                 }
//             }
//         )
//     }, $$('display_list'));


// function () {
//     var id = $$('display_list').getSelectedId().id;
//     db_connection.query(
//         `SELECT 1 FROM unavailable_tracks WHERE track_id=${id} LIMIT 1`,
//         function (error, result) {
//             if (error) throw error;
//             if (result.length == 0) {
//                 db_connection.query(
//                     `INSERT INTO unavailable_tracks (track_id) VALUES (${id})`,
//                     function (error, result) {
//                         if (error) throw error;
//                         $$('display_list').addRowCss(id, 'unavailable_track');
//                     }
//                 )
//             }
//         }
//     )
// }, $$('display_list'));


// function () {
//     var id = $$('display_list').getSelectedId().id;
//     db_connection.query(
//         `SELECT 1 FROM unavailable_tracks WHERE track_id=${id} LIMIT 1`,
//         function (error, result) {
//             if (error) throw error;
//             if (result.length > 0) {
//                 db_connection.query(
//                     `DELETE FROM unavailable_tracks WHERE track_id=${id}`,
//                     function (error, result) {
//                         if (error) throw error;
//                         $$('display_list').removeRowCss(id, 'unavailable_track');
//                         $$('display_list').getItem(id).$css="";
//                         $$('display_list').refresh();
//                     }
//                 )
//             }
//         }
//     )
// }, $$('display_list'));


// function refresh_queue() {
//     $QUERY(
//         `SELECT tracks.id as track_id, session_queue.id as id, session_queue.position, tracks.title, tracks.artist, tracks.album,
//          tracks.bpm, tracks.stream_length, settings.db_image_cache as image_root, tracks.cover_small as cover, session_queue.position as position
//          FROM (tracks LEFT JOIN settings ON 1) LEFT JOIN session_queue ON tracks.id=session_queue.track_id WHERE session_queue.status='pending'
//          ORDER BY session_queue.position`,
//         function(queue_content) {
//             $$('queue_list').clearAll();
//             for(var i=0; i < queue_content.length; i++){
//                 $$('queue_list').add(queue_content[i])
//             }
//         }
//     )
// }


// webix.UIManager.addHotKey("alt+r", refresh_queue);

// webix.UIManager.addHotKey("ctrl+shift+enter", function () {
//     var id = $$('queue_list').getSelectedItem().track_id;
//     preview_track_id = id;
//     preview_play_track_id(id, -30000000000);
// }, $$('queue_list'));
// webix.UIManager.addHotKey("shift+enter", function () {
//     var id = $$('queue_list').getSelectedItem().track_id;
//     preview_track_id = id;
//     preview_play_track_id(id, -10000000000);
// }, $$('queue_list'));
// webix.UIManager.addHotKey("enter", function () {
//     var id = $$('queue_list').getSelectedItem().track_id;
//     preview_track_id = id;
//     preview_play_track_id(id);
// }, $$('queue_list'));


// function () {
//     selected_queue_element = $$('queue_list').getSelectedItem();
//     selected_queue_element_position = $$('queue_list').getSelectedItem().position;
//     move_queue_element(selected_queue_element_position, 1,
//         function (new_position) {
//             move_displayed_queue_element(selected_queue_element, selected_queue_element_position, new_position);
//             $$('queue_list').moveTop(selected_queue_element.id)
//         }
//     )
// },
//$$('queue_list'));

// function () {
//     selected_queue_element = $$('queue_list').getSelectedItem();
//     selected_queue_element_position = $$('queue_list').getSelectedItem().position;
//     move_queue_element(selected_queue_element_position, selected_queue_element_position-1,
//         function (new_position) {
//             move_displayed_queue_element(selected_queue_element, selected_queue_element_position, new_position);
//             $$('queue_list').moveUp(selected_queue_element.id, 1)
//         }
//     )
// }, $$('queue_list'));

// function () {
//     selected_queue_element = $$('queue_list').getSelectedItem();
//     selected_queue_element_position = $$('queue_list').getSelectedItem().position;
//     move_queue_element(selected_queue_element_position, selected_queue_element_position+1,
//             function (new_position) {
//                 move_displayed_queue_element(selected_queue_element, selected_queue_element_position, new_position);
//                 $$('queue_list').moveDown(selected_queue_element.id, 1)
//         }
//     )
// }, $$('queue_list'));


// unction () {
//     selected_queue_element = $$('queue_list').getSelectedItem();
//     selected_queue_element_position = $$('queue_list').getSelectedItem().position;
//
//     delete_queue_element(selected_queue_element_position,
//         function () {
//             var next_item = $$('queue_list').getNextId(selected_queue_element.id);
//             if (next_item == undefined) {
//                 next_item = $$('queue_list').getPrevId(selected_queue_element.id);
//             }
//             $$('queue_list').remove(selected_queue_element.id);
//             $$('queue_list').data.each(
//                 function (element) {
//                     if (element.position > selected_queue_element_position) {
//                         element.position--;
//                     }
//                 }
//             );
//             if (next_item != undefined) {
//                 $$('queue_list').select(next_item)
//             }
//             $$('display_list').removeRowCss(selected_queue_element.track_id, 'unavailable_track');
//             $$('display_list').getItem(selected_queue_element.track_id).$css="";
//             $$('display_list').refresh();
//             update_queue_labels();
//         }
//     )
// }, $$('queue_list'));





// webix.UIManager.addHotKey("enter", function () {
//     var foo = $$('track_list_view')
//     var g = foo.getSelectedItem();
//     display_tag(g.id)();
//     $$('track_list_popup').hide();
//     webix.UIManager.setFocus($$('display_list'));
// }, $$('track_list_view'));


// genres_list_popup = webix.ui(genres_list_popup)
// genres_list_popup.hide();
// genres_list_popup.attachEvent('onShow', function () {
//     var sql = `SELECT DISTINCT genre as name, COUNT(id) as count FROM tracks GROUP BY genre ORDER BY genre`;
//     db_connection.query(sql, function (err, result) {
//       if (err) throw err;
//       $$('genres_list_view').clearAll()
//       //$$('genres_list_view').refresh()
//       $$('genres_list_view').define('data', result);
//       $$('genres_list_view').refresh()
//     });
// })
// $$('genres_list_view').attachEvent("onItemClick", function(id, e, node){
//     var item = this.getItem(id);
//     display_genre(item.name)();
//     $$('genres_list_popup').hide()
// });
// $$('genres_list_popup').attachEvent('onShow',
// function () {
//     webix.UIManager.setFocus($$('genres_list_view'));
// });
// $$('genres_list_popup').attachEvent('onHide',
// function () {
//     webix.UIManager.setFocus($$('display_list'));
// });
// webix.UIManager.addHotKey("enter", function () {
//     var foo = $$('genres_list_view')
//     var g = foo.getSelectedItem();
//     display_genre(g.name)();
//     $$('genres_list_popup').hide();
//     webix.UIManager.setFocus($$('display_list'));
// }, $$('genres_list_view'));


// sessions_list_popup = webix.ui(sessions_list_popup)
// sessions_list_popup.hide();
// sessions_list_popup.attachEvent('onShow', function () {
//     var sql = `SELECT id, event_name as name, date(start_date) as date, counts.count as count
//                FROM sessions JOIN (select session_id, count(track_id) as count FROM session_tracks
//                GROUP BY session_id) counts ON sessions.id=counts.session_id`
//
//     db_connection.query(sql, function (err, result) {
//       if (err) throw err;
//       $$('sessions_list_view').clearAll()
//       //$$('sessions_list_view').refresh()
//       $$('sessions_list_view').define('data', result);
//       $$('sessions_list_view').refresh()
//     });
// })
// $$('sessions_list_view').attachEvent("onItemClick", function(id, e, node){
//     var item = this.getItem(id);
//     display_session(item.id)();
//     $$('sessions_list_popup').hide();
// });
// $$('sessions_list_popup').attachEvent('onShow',
// function () {
//     webix.UIManager.setFocus($$('sessions_list_view'));
// });
// $$('sessions_list_popup').attachEvent('onHide',
// function () {
//     webix.UIManager.setFocus($$('display_list'));
// });
// webix.UIManager.addHotKey("enter", function () {
//     var foo = $$('sessions_list_view')
//     var g = foo.getSelectedItem();
//     display_session(g.id)();
//     $$('sessions_list_popup').hide();
//     webix.UIManager.setFocus($$('display_list'));
// }, $$('sessions_list_view'));



// track_list_popup = webix.ui(track_list_popup)
// track_list_popup.hide();
// track_list_popup.attachEvent('onShow', function () {
//     db_connection.query(
//         `SELECT playlists.id as id , playlists.name, counts.count as count, playlist_categories.color AS color FROM
//          playlists JOIN (SELECT playlist_id, count(track_id) as count FROM playlist_tracks GROUP BY playlist_id) counts
//          ON playlists.id=counts.playlist_id JOIN playlist_categories ON playlists.category=playlist_categories.id ORDER BY category`,
//         function (err, result) {
//             if (err) throw err;
//             $$('track_list_view').clearAll()
//             $$('track_list_view').define('data', result);
//             $$('track_list_view').refresh()
//         });
// })
// $$('track_list_view').attachEvent("onItemClick", function(id, e, node){
//     var item = this.getItem(id);
//     display_tag(item.id)();
//     $$('track_list_popup').hide()
// });
// $$('track_list_popup').attachEvent('onShow',
// function () {
//     webix.UIManager.setFocus($$('track_list_view'));
// });
// $$('track_list_popup').attachEvent('onHide',
// function () {
//     webix.UIManager.setFocus($$('display_list'));
// });


// var sql = `SELECT availability.track_id IS NULL as available, id, favorite, disabled as enabled, title, artist,
//            album, genre, date_added, date_modified, rating, bpm, stream_length, max(session_tracks.start_time) as last_played,
//            count(session_tracks.track_id) as play_count FROM tracks LEFT JOIN session_tracks ON tracks.id = session_tracks.track_id
//            LEFT JOIN ((select track_id from unavailable_tracks) union (select track_id from session_queue)) availability
//            ON availability.track_id=tracks.id GROUP BY id`
//
// $QUERY(sql, function (result) {
//     display_track_list('ALL SONGS', result);
//  });
//
// $$('queue_list').clearAll()



// var sql = `SELECT tracks.id as track_id, session_queue.id as id, session_queue.position, tracks.title, tracks.artist, tracks.album,
//            tracks.bpm, tracks.stream_length, settings.db_image_cache as image_root, tracks.cover_small as cover,
//            session_queue.position as position FROM (tracks LEFT JOIN settings ON 1) LEFT JOIN session_queue ON
//            tracks.id=session_queue.track_id WHERE session_queue.status='pending' ORDER BY session_queue.position`
//
// db_connection.query(sql, function (err, result) {
//   if (err) throw err;
//   for(var i=0; i < result.length; i++){
//       $$('queue_list').add(result[i])
//   }
// });



// function () {
//     $$('queue_list').clearAll()
//
//     var sql = `SELECT tracks.id as track_id, session_queue.id as id, session_queue.position, tracks.title, tracks.artist, tracks.album,
//                tracks.bpm, tracks.stream_length, settings.db_image_cache as image_root, tracks.cover_small as cover, session_queue.position as position
//                FROM (tracks LEFT JOIN settings ON 1) LEFT JOIN session_queue ON tracks.id=session_queue.track_id WHERE session_queue.status='pending'
//                ORDER BY session_queue.position`
//
//     db_connection.query(sql, function (err, result) {
//       if (err) throw err;
//       for(var i=0; i < result.length; i++){
//           $$('queue_list').add(result[i])
//       }
//     });
// });




//
// webix.UIManager.addHotKey("shift+q", function () {
//     var id = $$('display_list').getSelectedId().id;
//     sql = `SELECT 1 FROM session_queue WHERE track_id=${id} LIMIT 1`;
//     db_connection.query(sql,
//     function (err, result){
//         if (result.length == 0){
//             pos_id_sql = 'SELECT max(id) + 1 as new_id, max(position)+1 as new_position FROM session_queue';
//             db_connection.query(pos_id_sql, function (err, result) {
//                 if (!err){
//                     var new_id = result[0].new_id ? result[0].new_id :1;
//                     var new_position = result[0].new_id ? result[0].new_position :1;
//                     insert_sql = `INSERT INTO session_queue (id, track_id, status, position)
//                                   VALUES (${new_id}, ${id}, 'pending', ${new_position})`;
//                     db_connection.query(insert_sql, function (err, result) {
//                         if (err) throw err;
//                         sql = `SELECT tracks.id as track_id, session_queue.position, tracks.title, tracks.artist,
//                                         tracks.album, tracks.bpm, tracks.stream_length,
//                                         settings.db_image_cache as image_root, tracks.cover_small as cover,
//                                         session_queue.position as position
//                                  FROM
//                                      (tracks LEFT JOIN settings ON 1) LEFT JOIN session_queue
//                                  ON
//                                      tracks.id=session_queue.track_id WHERE session_queue.status='pending'
//                                  AND
//                                     session_queue.track_id=${id}
//                                  ORDER BY session_queue.position`;
//                         db_connection.query(sql, function (err, result) {
//                             if (err) throw err;
//                             $$('queue_list').add(result[0]);
//                             $$('display_list').addRowCss(id, 'unavailable_track');
//                             update_queue_labels();
//                         });
//                     });
//                 }
//             })
//         }
//     });
// }, $$('display_list'));
//


// function get_track_info_for_queue(track_id, cont) {
//     var sql = `SELECT tracks.id as track_id, session_queue.id as id, session_queue.position, tracks.title, tracks.artist,
//                     tracks.album, tracks.bpm, tracks.stream_length,
//                     settings.db_image_cache as image_root, tracks.cover_small as cover,
//                     session_queue.position as position
//              FROM
//                  (tracks LEFT JOIN settings ON 1) LEFT JOIN session_queue
//              ON
//                  tracks.id=session_queue.track_id
//             WHERE tracks.id=${track_id}
//              ORDER BY session_queue.position`;
//     db_connection.query(sql, function(error, result) {
//         if (error) throw error;
//         cont(result[0]);
//     })
// }

// function get_track_id_at_queue_position(position, continuation) {
//     db_connection.query(
//         `SELECT id, track_id FROM session_queue WHERE position=${position}`,
//         function (err, result) {
//             if (err) throw err;
//             continuation(result[0].id, result[0].track_id)
//         }
//     )
// }

//
// function get_queue_boundary_positions(cont){
//     sql = "SELECT min(position) as min, max(position) as max FROM session_queue WHERE status='pending'"
//     db_connection.query(sql, function(error, result){
//         if (error) throw error;
//         return cont(result[0].min, result[0].max)
//     })
// }


// webix.UIManager.addHotKey("u", function () {
//     selected_queue_element = $$('queue_list').getSelectedItem();
//     selected_queue_element_position = $$('queue_list').getSelectedItem().position;
//     swapped_element = $$('queue_list').getItem($$('queue_list').getPrevId(selected_queue_element.id));
//
//     get_queue_boundary_positions(
//         function (min, max) {
//             new_position = Math.max(selected_queue_element_position - 1, min)
//             if (new_position != selected_queue_element_position) {
//                 db_connection.query(
//                     `UPDATE session_queue SET position=0 WHERE position=${new_position}`,
//                     function(err, result) {
//                         if (err) throw err;
//                         db_connection.query(
//                             `UPDATE session_queue SET position=${new_position} WHERE position=${selected_queue_element_position}`,
//                             function (err, result) {
//                                 if (err) throw err;
//                                 db_connection.query(
//                                     `UPDATE session_queue SET position=${selected_queue_element_position} WHERE position=0`,
//                                     function (err, result) {
//                                         if (err) throw err;
//                                         swapped_element.position = selected_queue_element_position;
//                                         selected_queue_element.position = new_position;
//                                         $$('queue_list').moveUp(selected_queue_element.id, 1)
//                                     }
//                                 )
//                             }
//                         )
//                     }
//                 )
//             }
//         }
//     )
// }, $$('queue_list'));


// webix.UIManager.addHotKey("d", function () {
//     selected_queue_element = $$('queue_list').getSelectedItem();
//     selected_queue_element_position = $$('queue_list').getSelectedItem().position;
//     swapped_element = $$('queue_list').getItem($$('queue_list').getNextId(selected_queue_element.id));
//     get_queue_boundary_positions(
//         function (min, max) {
//             new_position = Math.min(selected_queue_element_position + 1, max)
//             if (new_position != selected_queue_element_position) {
//                 db_connection.query(
//                     `UPDATE session_queue SET position=0 WHERE position=${new_position}`,
//                     function(err, result) {
//                         if (err) throw err;
//                         db_connection.query(
//                             `UPDATE session_queue SET position=${new_position} WHERE position=${selected_queue_element_position}`,
//                             function (err, result) {
//                                 if (err) throw err;
//                                 db_connection.query(
//                                     `UPDATE session_queue SET position=${selected_queue_element_position} WHERE position=0`,
//                                     function (err, result) {
//                                         if (err) throw err;
//                                         swapped_element.position = selected_queue_element_position;
//                                         selected_queue_element.position = new_position;
//                                         $$('queue_list').moveDown(selected_queue_element.id, 1)
//                                     }
//                                 )
//                             }
//                         )
//                     }
//                 )
//             }
//         }
//     )
// }, $$('queue_list'));
//


// webix.UIManager.addHotKey("t", function () {
//     selected_queue_element = $$('queue_list').getSelectedItem();
//     selected_queue_element_position = $$('queue_list').getSelectedItem().position;
//     get_queue_boundary_positions(
//         function (min, max) {
//             new_position = min
//             if (new_position != selected_queue_element_position) {
//                 db_connection.query(
//                     `UPDATE session_queue SET position=0 WHERE position=${selected_queue_element_position}`,
//                     function(err, result) {
//                         if (err) throw err;
//                         db_connection.query(
//                             `UPDATE session_queue SET position=position+1 WHERE position>=${min}`,
//                             function (err, result) {
//                                 if (err) throw err;
//                                 $$('queue_list').data.each(
//                                     function (element) {
//                                         if (element.position >= min) {
//                                             element.position++;
//                                         }
//                                     }
//                                 );
//                                 db_connection.query(
//                                     `UPDATE session_queue SET position=position-1 WHERE position>${selected_queue_element_position}`,
//                                     function (err, result) {
//                                         if (err) throw err;
//                                         $$('queue_list').data.each(
//                                             function (element) {
//                                                 if (element.position > selected_queue_element_position) {
//                                                     element.position--;
//                                                 }
//                                             }
//                                         );
//                                         db_connection.query(
//                                             `UPDATE session_queue SET position=${new_position} WHERE position=0`,
//                                             function (err, result) {
//                                                 selected_queue_element.position = new_position;
//                                                 $$('queue_list').moveTop(selected_queue_element.id)
//
//                                             }
//                                         )
//                                     }
//                                 )
//                             }
//                         )
//                     }
//                 )
//             }
//         }
//     )
// }, $$('queue_list'));

//
//
//
//
//
// webix.UIManager.addHotKey("shift+backspace", function () {
//     selected_queue_element = $$('queue_list').getSelectedItem();
//     selected_queue_element_position = $$('queue_list').getSelectedItem().position;
//     // console.log(selected_queue_element.position);
//     get_queue_boundary_positions(
//         function (min, max) {
//             db_connection.query(
//                 `UPDATE session_queue SET position=0 WHERE position=${selected_queue_element_position}`,
//                 function(err, result) {
//                      db_connection.query(
//                         `UPDATE session_queue SET position=position-1 WHERE position>${selected_queue_element_position}`,
//                         function (err, result) {
//                             if (err) throw err;
//                             db_connection.query(
//                                 `DELETE FROM session_queue WHERE position=0`,
//                                 function (err, result) {
//                                     var next_item = $$('queue_list').getNextId(selected_queue_element.id);
//                                     if (next_item == undefined) {
//                                         next_item = $$('queue_list').getPrevId(selected_queue_element.id);
//                                     }
//                                     $$('queue_list').remove(selected_queue_element.id);
//                                     $$('queue_list').data.each(
//                                         function (element) {
//                                             if (element.position > selected_queue_element_position) {
//                                                 element.position--;
//                                             }
//                                         }
//                                     );
//                                     if (next_item != undefined) {
//                                         $$('queue_list').select(next_item)
//                                     }
//                                     console.log(next_item);
//                                     $$('display_list').removeRowCss(selected_queue_element.track_id, 'unavailable_track');
//                                     $$('display_list').getItem(selected_queue_element.track_id).$css="";
//                                     $$('display_list').refresh();
//                                     update_queue_labels();
//                                 }
//                             )
//                         }
//                     )
//                 }
//             )
//         }
//     )
// }, $$('queue_list'));
//
//


</script>
